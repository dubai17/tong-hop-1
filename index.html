<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá Th·ªëng Qu·∫£n Tr·ªã Doanh Nghi·ªáp PRO (Final Fix CRM)</title>
    <style>
        :root {
            --primary-color: #007bff; --secondary-color: #6c757d; --success-color: #28a745;
            --danger-color: #dc3545; --warning-color: #ffc107; --info-color: #17a2b8;
            --light-bg: #f4f6f8; --white: #ffffff; --border-color: #dee2e6;
        }
        body { font-family: 'Segoe UI', Roboto, sans-serif; margin: 0; padding: 0; background-color: var(--light-bg); color: #333; font-size: 14px; }
        
        /* HEADER & TABS */
        .header { background-color: var(--primary-color); color: var(--white); padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .header h1 { margin: 0; font-size: 20px; font-weight: 600; }
        .nav-tabs { display: flex; background-color: var(--white); padding: 0 20px; border-bottom: 1px solid var(--border-color); overflow-x: auto; }
        .nav-item { padding: 15px 20px; cursor: pointer; font-weight: 500; color: var(--secondary-color); border-bottom: 3px solid transparent; transition: all 0.3s; white-space: nowrap; }
        .nav-item:hover { color: var(--primary-color); background-color: #f8f9fa; }
        .nav-item.active { color: var(--primary-color); border-bottom: 3px solid var(--primary-color); background-color: #eef7ff; }
        .main-content { padding: 20px; max-width: 100%; margin: 0 auto; }
        .tab-pane { display: none; }
        .tab-pane.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* LAYOUTS */
        .card { background: var(--white); border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); padding: 15px; margin-bottom: 15px; border: 1px solid var(--border-color); }
        .sales-layout { display: grid; grid-template-columns: 35% 63%; gap: 2%; }
        .expense-layout { display: grid; grid-template-columns: 40% 58%; gap: 2%; }
        .inventory-layout { display: grid; grid-template-columns: 40% 58%; gap: 2%; }
        .crm-layout { display: grid; grid-template-columns: 30% 68%; gap: 2%; height: calc(100vh - 140px); }
        
        /* CHART STYLES */
        .chart-container { display: flex; align-items: flex-end; justify-content: space-around; height: 250px; padding-top: 30px; border-bottom: 1px solid #ccc; gap: 15px; }
        .chart-column { flex: 1; display: flex; flex-direction: column; justify-content: flex-end; align-items: center; position: relative; max-width: 80px; }
        .chart-bar { width: 100%; border-radius: 4px 4px 0 0; transition: height 0.8s ease; min-height: 2px; position: relative; cursor: pointer; }
        .chart-bar:hover { opacity: 0.85; }
        .chart-value { position: absolute; top: -25px; left: 50%; transform: translateX(-50%); font-size: 11px; font-weight: bold; color: #333; white-space: nowrap; }
        .chart-label { margin-top: 8px; font-size: 11px; text-align: center; color: #555; word-wrap: break-word; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; line-height: 1.2; height: 28px; }

        /* CRM STYLES */
        .crm-sidebar { overflow-y: auto; border-right: 1px solid #eee; padding-right: 10px; }
        .crm-detail { overflow-y: auto; padding-left: 20px; }
        .cust-item { padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; transition: 0.2s; border-radius: 4px; margin-bottom: 5px; background: #fff;}
        .cust-item:hover { background-color: #f8f9fa; }
        .cust-item.active { background-color: #eef7ff; border-left: 4px solid var(--primary-color); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .cust-name { font-weight: bold; font-size: 15px; margin-bottom: 3px;}
        .cust-phone { font-size: 13px; color: #666; display: flex; align-items: center; gap: 5px;}
        
        /* CRM INFO BOX */
        .crm-info-box { display: flex; gap: 20px; margin-bottom: 20px; }
        .crm-stat-card { flex: 1; background: #fff; padding: 15px; border-radius: 8px; border: 1px solid #eee; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .crm-stat-card h4 { margin: 0 0 5px 0; font-size: 13px; color: #777; font-weight: normal; text-transform: uppercase; }
        .crm-stat-card div { font-size: 20px; font-weight: bold; color: var(--primary-color); }

        /* FORM & BUTTONS */
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; }
        .form-control { width: 100%; padding: 8px 10px; border: 1px solid #ced4da; border-radius: 4px; font-size: 13px; box-sizing: border-box; }
        .form-control:focus { border-color: var(--primary-color); outline: none; }
        .btn { padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; font-weight: 500; font-size: 13px; display: inline-flex; align-items: center; gap: 5px; }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-success { background-color: var(--success-color); color: white; }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-secondary { background-color: var(--secondary-color); color: white; }
        .btn-warning { background-color: var(--warning-color); color: #333; }
        .btn-info { background-color: var(--info-color); color: white; }
        .btn-sm { padding: 4px 8px; font-size: 11px; }

        /* TABLES */
        table { width: 100%; border-collapse: collapse; margin-top: 5px; font-size: 13px; }
        th { background-color: #f1f3f5; padding: 10px; text-align: left; border-bottom: 2px solid var(--border-color); cursor: pointer; user-select: none;}
        th:hover { background-color: #e2e6ea; }
        td { padding: 10px; border-bottom: 1px solid var(--border-color); }
        .text-right { text-align: right; }
        .text-center { text-align: center; }

        /* INVOICE PREVIEW */
        .invoice-box { background: #fff; padding: 30px; border: 1px solid #ccc; font-family: 'Times New Roman', Times, serif; font-size: 14px; line-height: 1.4; color: #000; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        .inv-title { text-align: center; text-transform: uppercase; font-weight: bold; font-size: 22px; margin-bottom: 5px; }
        .inv-sub-title { text-align: center; font-style: italic; margin-bottom: 20px; font-size: 13px; }
        .inv-table { width: 100%; border-collapse: collapse; margin: 15px 0; }
        .inv-table th { background-color: #4472c4; color: white; text-align: center; border: 1px solid #ccc; padding: 5px; -webkit-print-color-adjust: exact; }
        .inv-table td { border: 1px solid #ccc; padding: 5px; }
        .inv-info-grid { display: flex; justify-content: space-between; margin-bottom: 10px; }
        .inv-total-section { margin-top: 10px; display: flex; justify-content: flex-end; }
        .inv-total-table { width: 50%; }
        .inv-footer-grid { display: flex; justify-content: space-between; margin-top: 30px; text-align: center; }

        /* DASHBOARD */
        .dashboard-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px; }
        .kpi-card { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-left: 4px solid #ccc; }
        .kpi-card h3 { margin: 0 0 10px 0; font-size: 14px; color: #666; text-transform: uppercase; }
        .kpi-card .value { font-size: 24px; font-weight: bold; color: #333; }
        .kpi-card.revenue { border-color: var(--primary-color); }
        .kpi-card.cost { border-color: var(--warning-color); }
        .kpi-card.expense { border-color: var(--danger-color); }
        .kpi-card.profit { border-color: var(--success-color); }
        
        .progress-bar-container { width: 100%; background-color: #e9ecef; border-radius: 4px; height: 10px; margin-top: 5px; }
        .progress-bar { height: 100%; border-radius: 4px; text-align: center; color: white; font-size: 11px; line-height: 20px; transition: width 0.5s; }
        .filter-bar { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; align-items: center;}
        
        /* Custom Date Range Style */
        .custom-filter-container { display: none; background: #fff; padding: 5px 10px; border-radius: 4px; border: 1px solid #ccc; gap: 10px; align-items: center; margin-left: 10px; }
        .custom-filter-container.active { display: flex; }

        .editable-input { width: 100%; padding: 4px; border: 1px solid #89c2ff; border-radius: 3px; font-family: inherit; }
        #editModeBanner { background: #ffc107; color: #333; padding: 10px; text-align: center; font-weight: bold; margin-bottom: 15px; display: none; border-radius: 4px; }
        
        /* Modal */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888; width: 800px; max-width: 90%; border-radius: 8px; position: relative; }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

<div class="header">
    <div style="display: flex; align-items: center; gap: 10px;">
        <span style="font-size: 24px;">üè¢</span>
        <h1>H·ªá Th·ªëng Qu·∫£n Tr·ªã Doanh Nghi·ªáp PRO</h1>
    </div>
    <div>
        <button class="btn btn-secondary btn-sm" onclick="exportData()">üíæ Sao L∆∞u</button>
        <button class="btn btn-warning btn-sm" onclick="document.getElementById('fileInput').click()">üìÇ Ph·ª•c H·ªìi</button>
        <input type="file" id="fileInput" accept=".json" style="display:none;">
    </div>
</div>

<div class="nav-tabs">
    <div class="nav-item active" onclick="switchTab('tab-sales')">üõí B√°n H√†ng</div>
    <div class="nav-item" onclick="switchTab('tab-cashflow')">üí∏ Thu Chi</div>
    <div class="nav-item" onclick="switchTab('tab-customers')">üë• Kh√°ch H√†ng</div>
    <div class="nav-item" onclick="switchTab('tab-staff')">üßë‚Äçüíº Nh√¢n S·ª±</div>
    <div class="nav-item" onclick="switchTab('tab-inventory')">üì¶ Kho H√†ng</div>
    <div class="nav-item" onclick="switchTab('tab-reports')">üìä B√°o C√°o</div>
</div>

<div class="main-content">

    <div id="tab-sales" class="tab-pane active">
        <div id="editModeBanner">‚ö†Ô∏è ƒêANG S·ª¨A ƒê∆†N H√ÄNG: <span id="editingOrderIDText"></span></div>
        <div class="sales-layout">
            <div>
                <div class="card" id="salesCardInfo">
                    <h5 style="margin:0 0 10px 0; color:var(--primary-color);">1. Th√¥ng tin Chung</h5>
                    <div style="margin-bottom: 10px;">
                        <label style="font-size:12px; font-weight:bold;">Ng√†y ƒë∆°n h√†ng:</label>
                        <input type="date" id="orderDate" class="form-control" onchange="updateInvoicePreview()">
                    </div>
                    
                    <div style="margin-bottom: 10px;"><select id="saleStaffSelect" class="form-control" onchange="updateInvoicePreview()"><option value="">-- Ch·ªçn sales --</option></select></div>
                    <div style="display: grid; gap: 10px;">
                        <input type="text" id="custPhone" class="form-control" placeholder="SƒêT Kh√°ch (*)" onblur="findCustomerByPhone()" oninput="updateInvoicePreview()">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px;">
                            <input type="text" id="custName" class="form-control" placeholder="T√™n kh√°ch" oninput="updateInvoicePreview()">
                            <input type="text" id="custAddress" class="form-control" placeholder="ƒê·ªãa ch·ªâ" oninput="updateInvoicePreview()">
                        </div>
                    </div>
                </div>
                <div class="card">
                    <h5 style="margin:0 0 10px 0; color:var(--primary-color);">2. Ch·ªçn H√†ng (G√µ t√¨m ki·∫øm)</h5>
                    <datalist id="productListSales"></datalist>
                    <table id="orderItemsTable" style="margin-top:0;"><thead><tr><th style="width: 45%">T√™n H√†ng (k√®m gi√° v·ªën)</th><th style="width: 15%">SL</th><th style="width: 25%">ƒê∆°n gi√°</th><th style="width: 15%"></th></tr></thead><tbody id="orderItemsBody"></tbody></table>
                    <button class="btn btn-secondary btn-sm" style="width:100%; margin-top:5px;" onclick="createOrderItemRow()">‚ûï Th√™m d√≤ng</button>
                </div>
                <div class="card">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                         <div><label style="font-size:12px;">Ph√≠ Ship/Kh√°c (+/-)</label><input type="number" id="shippingCost" class="form-control" value="0" oninput="updateInvoicePreview()"></div>
                         <div><label style="font-size:12px;">Ghi ch√∫</label><input type="text" id="orderNote" class="form-control" placeholder="..." oninput="updateInvoicePreview()"></div>
                    </div>
                    <div style="margin-top: 15px; display: flex; gap: 10px;">
                        <button id="btnSaveOrder" class="btn btn-primary" style="flex: 1; padding: 10px;" onclick="submitOrder()">‚úÖ L∆ØU ƒê∆†N</button>
                        <button id="btnCancelEdit" class="btn btn-secondary" style="display:none; padding: 10px;" onclick="cancelEditOrder()">‚ùå H·ª¶Y</button>
                    </div>
                </div>
            </div>
            <div>
                <div class="card" style="background: #ccc; padding: 20px; height: calc(100vh - 150px); overflow-y: auto;">
                    <div id="invoicePreview" class="invoice-box">
                        <div class="inv-title">PHI·∫æU XU·∫§T KHO B√ÅN H√ÄNG</div>
                        <div class="inv-sub-title">Ng√†y: <span id="invDate">...</span><br>NV: <span id="invStaff" style="font-weight:bold">...</span> - SƒêT: <span id="invStaffPhone">...</span></div>
                        <div class="inv-info-grid"><div class="inv-info-left"><div>Kh√°ch: <span id="invCustName" style="font-weight:bold">...</span></div><div>SƒêT: <span id="invCustPhone">...</span></div><div>ƒêC: <span id="invCustAddr">...</span></div></div><div class="inv-info-right"><div style="font-weight:bold">S·ªê: <span id="invID">...</span></div></div></div>
                        <table class="inv-table"><thead><tr><th>STT</th><th>T√äN H√ÄNG</th><th>ƒêVT</th><th>SL</th><th>ƒê∆†N GI√Å</th><th>TH√ÄNH TI·ªÄN</th></tr></thead><tbody id="invItemsList"></tbody></table>
                        <div class="inv-total-section"><table class="inv-total-table"><tr><td>C·ªông ti·ªÅn h√†ng:</td><td><span id="invSubTotal">0</span></td></tr><tr><td>Ph√≠ Ship/Kh√°c:</td><td><span id="invShip">0</span></td></tr><tr><td class="inv-total-label" style="color:#dc3545">T·ªïng thanh to√°n:</td><td class="inv-total-value"><span id="invTotal">0</span></td></tr></table></div>
                        <div style="margin-top:10px;font-style:italic">B·∫±ng ch·ªØ: <span id="invTotalText">...</span></div>
                        <div class="inv-footer-grid"><div><strong>Ng∆∞·ªùi mua</strong><br><em>(K√Ω t√™n)</em></div><div><strong>K·∫ø to√°n</strong><br><em>(K√Ω t√™n)</em></div><div><strong>Gi√°m ƒë·ªëc</strong><br><em>(K√Ω t√™n)</em></div></div>
                    </div>
                    <div style="text-align: center; margin-top: 15px;"><button class="btn btn-secondary" onclick="printInvoice()">üñ®Ô∏è In Phi·∫øu</button></div>
                </div>
            </div>
        </div>
    </div>

    <div id="tab-cashflow" class="tab-pane">
        <div class="expense-layout">
            <div class="card"><h3 style="color: var(--primary-color);">üìù L·∫≠p Phi·∫øu Thu / Chi</h3>
            <form id="cashflowForm" class="form-grid" style="grid-template-columns: 1fr;">
                <div style="display:flex; gap:10px;">
                    <div style="flex:1"><label>Lo·∫°i phi·∫øu:</label><select id="cfType" class="form-control" style="font-weight:bold;"><option value="THU" style="color:green">‚ûï PHI·∫æU THU</option><option value="CHI" style="color:red">‚ûñ PHI·∫æU CHI</option></select></div>
                    <div style="flex:1"><label>Ng√†y:</label><input type="date" id="cfDate" class="form-control" required></div>
                </div>
                <div><label>S·ªë ti·ªÅn (VND):</label><input type="number" id="cfAmount" class="form-control" required min="0"></div>
                <div>
                    <label>ƒê∆°n h√†ng li√™n quan (M√£ PXK - T√πy ch·ªçn):</label>
                    <input type="text" id="cfOrderId" class="form-control" list="orderListSuggestions" placeholder="G√µ m√£ ƒë∆°n ho·∫∑c ch·ªçn...">
                    <datalist id="orderListSuggestions"></datalist>
                </div>
                <div><label>H·∫°ng m·ª•c:</label><input type="text" id="cfCategory" class="form-control" list="catList" placeholder="VD: Ti·ªÅn ƒëi·ªán, Ship, B√°n ph·∫ø li·ªáu..."><datalist id="catList"><option value="Ti·ªÅn ƒëi·ªán/n∆∞·ªõc"><option value="L∆∞∆°ng nh√¢n vi√™n"><option value="Thu√™ m·∫∑t b·∫±ng"><option value="Ph√≠ Ship"><option value="Thu kh√°c"></datalist></div>
                <div><label>Ghi ch√∫:</label><input type="text" id="cfNote" class="form-control"></div>
                <button type="submit" class="btn btn-primary">üíæ L∆∞u Phi·∫øu</button>
            </form>
            </div>
            <div class="card"><h3>üìú L·ªãch S·ª≠ Thu Chi</h3><div style="max-height: 400px; overflow-y: auto;"><table id="cashflowTable"><thead><tr><th>Ng√†y</th><th>Lo·∫°i</th><th>S·ªë ti·ªÅn</th><th>ƒê∆°n h√†ng</th><th>M·ª•c</th><th>X√≥a</th></tr></thead><tbody></tbody></table></div></div>
        </div>
    </div>

    <div id="tab-customers" class="tab-pane">
        <div class="card" style="height: 100%; overflow: hidden;">
            <div class="crm-layout">
                <div class="crm-sidebar">
                    <div style="position: sticky; top: 0; background: white; padding-bottom: 10px; border-bottom: 1px solid #eee; margin-bottom: 10px;">
                        <input type="text" id="crmSearch" class="form-control" placeholder="üîç T√¨m SƒêT ho·∫∑c T√™n..." oninput="renderCrmSidebar()">
                    </div>
                    <div id="crmCustomerList"></div>
                </div>
                <div class="crm-detail" id="crmDetailView">
                    <div style="text-align: center; color: #888; margin-top: 100px;">
                        <span style="font-size: 50px;">üë•</span>
                        <h3>Ch·ªçn m·ªôt kh√°ch h√†ng t·ª´ danh s√°ch b√™n tr√°i</h3>
                        <p>Th√¥ng tin chi ti·∫øt v√† l·ªãch s·ª≠ ƒë∆°n h√†ng s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="tab-staff" class="tab-pane">
        <div class="card"><h3>Th√™m Nh√¢n Vi√™n</h3><form id="addStaffForm" class="form-grid"><input type="text" id="staffName" class="form-control" required placeholder="T√™n"><input type="text" id="staffPhone" class="form-control" placeholder="SƒêT"><input type="text" id="staffAddress" class="form-control" placeholder="ƒêC"><input type="text" id="staffNote" class="form-control" placeholder="Note"><button class="btn btn-success">‚ûï Th√™m</button></form></div>
        <div class="card"><h3>Danh S√°ch Sales</h3><table id="staffTable"><thead><tr><th>T√™n</th><th>SƒêT</th><th>ƒêC</th><th>Note</th><th>X√≥a</th></tr></thead><tbody></tbody></table></div>
    </div>

    <div id="tab-inventory" class="tab-pane">
        <div class="inventory-layout">
            <div class="card">
                <h3 style="color: var(--info-color);">üè≠ Nh√† Cung C·∫•p</h3>
                <input type="text" id="searchSupplier" class="form-control" placeholder="üîç T√¨m NCC..." style="margin-bottom: 10px;" oninput="renderSuppliers()">
                <form id="addSupplierForm" class="form-grid" style="margin-bottom: 15px;"><input type="text" id="suppName" class="form-control" required placeholder="T√™n NCC"><input type="text" id="suppPhone" class="form-control" placeholder="SƒêT"><input type="text" id="suppAddr" class="form-control" placeholder="ƒêC"><button type="submit" class="btn btn-info">‚ûï Th√™m NCC</button></form>
                <div style="max-height: 200px; overflow-y: auto; border: 1px solid #eee;">
                    <table id="supplierTable" style="margin-top:0;"><thead><tr><th>T√™n NCC</th><th>SƒêT</th><th>ƒê·ªãa ch·ªâ</th><th>X√≥a</th></tr></thead><tbody></tbody></table>
                </div>
            </div>
            <div class="card">
                <h3>üì¶ Nh·∫≠p H√†ng M·ªõi</h3>
                <div style="margin-bottom: 10px; display: flex; gap: 10px; align-items: flex-end;">
                    <div style="flex:1;">
                        <label>Nh√† Cung C·∫•p:</label>
                        <select id="stockSupplier" class="form-control"><option value="">-- Ch·ªçn NCC --</option></select>
                    </div>
                    <div style="flex:1;">
                        <label>Ng√†y nh·∫≠p:</label>
                        <input type="date" id="importDate" class="form-control">
                    </div>
                </div>
                
                <datalist id="productListStock"></datalist>
                <table id="stockEntryTable" style="margin-bottom: 15px;"><thead><tr><th style="width: 35%">T√™n SP (G·ª£i √Ω)</th><th style="width: 15%">SL</th><th style="width: 25%">Gi√° v·ªën</th><th style="width: 15%">Ghi ch√∫</th><th style="width: 10%"></th></tr></thead><tbody id="stockEntryBody"></tbody></table>
                <div style="display: flex; justify-content: space-between;">
                    <button class="btn btn-secondary btn-sm" onclick="createStockRow()">‚ûï Th√™m d√≤ng</button>
                    <div>
                         <button class="btn btn-warning" onclick="syncWithGoogleSheets()">‚òÅÔ∏è ƒê·ªìng b·ªô t·ª´ Sheet</button>
                         <button class="btn btn-success" onclick="submitStockEntry()">‚úÖ NH·∫¨P KHO</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3>üìä Danh S√°ch T·ªìn Kho</h3>
                <div>
                    <select id="filterSupplier" class="form-control" style="display:inline-block; width:150px;" onchange="renderInventory()">
                        <option value="">T·∫•t c·∫£ NCC</option>
                    </select>
                    <button class="btn btn-secondary btn-sm" onclick="sortInventory('stock')">üîΩ T·ªìn nhi·ªÅu</button>
                    <button class="btn btn-secondary btn-sm" onclick="sortInventory('sold')">üîΩ B√°n ch·∫°y</button>
                </div>
            </div>
            <table id="inventoryTable"><thead><tr><th>T√™n SP</th><th>NCC</th><th>Nh·∫≠p</th><th>B√°n</th><th>T·ªìn</th><th>Gi√° V·ªën</th><th>Ghi ch√∫</th><th>X√≥a</th></tr></thead><tbody></tbody></table>
        </div>
    </div>

    <div id="tab-reports" class="tab-pane">
        <div class="filter-bar">
            <button id="btn-today" class="btn btn-secondary" onclick="filterReports('today')">H√¥m nay</button>
            <button id="btn-week" class="btn btn-secondary" onclick="filterReports('week')">Tu·∫ßn n√†y</button>
            <button id="btn-month" class="btn btn-secondary" onclick="filterReports('month')">Th√°ng n√†y</button>
            <button id="btn-year" class="btn btn-secondary" onclick="filterReports('year')">NƒÉm nay</button>
            <button id="btn-all" class="btn btn-secondary" onclick="filterReports('all')">T·∫•t c·∫£</button>
            
            <button id="btn-custom" class="btn btn-secondary" onclick="toggleCustomFilter()">üìÖ T√πy ch·ªçn</button>
            
            <div id="customFilterArea" class="custom-filter-container">
                <span style="font-weight:bold;">T·ª´:</span>
                <input type="date" id="filterStart" class="form-control" style="width: auto;">
                <span style="font-weight:bold;">ƒê·∫øn:</span>
                <input type="date" id="filterEnd" class="form-control" style="width: auto;">
                <button class="btn btn-primary btn-sm" onclick="filterReports('custom')">üîç L·ªçc d·ªØ li·ªáu</button>
            </div>
        </div>

        <div class="dashboard-grid"><div class="kpi-card revenue"><h3>DOANH THU (ƒê∆°n h√†ng)</h3><div class="value" id="kpiRevenue">0 ‚Ç´</div></div><div class="kpi-card cost"><h3>T·ªîNG V·ªêN NH·∫¨P (Kho)</h3><div class="value" id="kpiTotalImport">0 ‚Ç´</div></div><div class="kpi-card expense"><h3>T·ªîNG CHI (Ngo√†i v·ªën)</h3><div class="value" id="kpiTotalExpense">0 ‚Ç´</div></div><div class="kpi-card profit"><h3>L·ª¢I NHU·∫¨N R√íNG</h3><div class="value" id="kpiNetProfit">0 ‚Ç´</div></div></div>
        
        <div class="sales-layout" style="margin-bottom: 20px;">
            <div class="card">
                <h4 style="border-bottom: 2px solid var(--primary-color); padding-bottom: 5px; color: var(--primary-color);">üèÜ Top Sales (Doanh s·ªë)</h4>
                <div id="chartTopSales"></div>
            </div>
            <div class="card">
                <h4 style="border-bottom: 2px solid var(--success-color); padding-bottom: 5px; color: var(--success-color);">üíé Top Kh√°ch H√†ng</h4>
                <div id="chartTopCustomers"></div>
            </div>
        </div>

        <div class="sales-layout">
            <div class="card"><h4>üìä B·∫£ng C√¢n ƒê·ªëi T√†i Ch√≠nh</h4><div style="margin-bottom:10px;"><span>T·ª∑ su·∫•t LN: <strong id="profitMargin">0%</strong></span><div class="progress-bar-container"><div id="barProfit" class="progress-bar" style="width:0%; background-color:var(--success-color);"></div></div></div><table class="table"><tr><td>(+) Doanh Thu B√°n H√†ng:</td><td class="text-right" id="rptRev">0</td></tr><tr><td>(-) Gi√° V·ªën H√†ng B√°n:</td><td class="text-right" id="rptCOGS">0</td></tr><tr><td style="font-weight:bold;">= L√£i G·ªôp ƒê∆°n H√†ng:</td><td class="text-right" style="font-weight:bold;" id="rptGrossProfit">0</td></tr><tr><td>(+) Thu Kh√°c (Ngo√†i b√°n h√†ng):</td><td class="text-right" id="rptOtherInc" style="color:green">0</td></tr><tr><td>(-) T·ªïng Chi Ph√≠ (V·∫≠n h√†nh + ƒê∆°n):</td><td class="text-right" id="rptOtherExp" style="color:red">0</td></tr><tr style="background:#eef7ff;"><td style="font-weight:bold;color:green;font-size:16px;">= L·ª£i Nhu·∫≠n R√≤ng:</td><td class="text-right" style="font-weight:bold;color:green;font-size:16px;" id="rptNetProfit">0</td></tr></table></div>
            <div class="card"><div style="display:flex; justify-content:space-between; align-items:center;"><h4>üìú L·ªãch S·ª≠ ƒê∆°n H√†ng</h4><input type="text" id="searchOrderReport" class="form-control" style="width:150px;" placeholder="T√¨m M√£ ƒêH..." oninput="searchOrderTable()"></div><div style="max-height: 400px; overflow-y:auto;"><table id="rptOrdersTable"><thead><tr><th>Kh√°ch h√†ng</th><th>M√£</th><th>Ng√†y</th><th>Doanh thu</th><th>L√£i th·ª±c</th><th>Thao t√°c</th></tr></thead><tbody></tbody></table></div></div>
        </div>
        <div class="card"><h4>üí∏ Chi Ti·∫øt Chi Ph√≠</h4><div style="display:flex;gap:20px;"><div style="flex:1;"><h5>Chi ph√≠ ƒê∆°n h√†ng</h5><table id="rptOrderExpTable"><thead><tr><th>M√£ ƒêH</th><th>S·ªë ti·ªÅn</th><th>L√Ω do</th></tr></thead><tbody></tbody></table></div><div style="flex:1;"><h5>Chi ph√≠ V·∫≠n h√†nh</h5><table id="rptGenExpTable"><thead><tr><th>Ng√†y</th><th>Lo·∫°i</th><th>S·ªë ti·ªÅn</th></tr></thead><tbody></tbody></table></div></div></div>
    </div>

</div>

<div id="invoiceModal" class="modal"><div class="modal-content"><span class="close" onclick="document.getElementById('invoiceModal').style.display='none'">&times;</span><div id="modalInvoiceContent"></div><div style="text-align: center; margin-top: 20px;"><button class="btn btn-secondary" onclick="printModalInvoice()">üñ®Ô∏è In Phi·∫øu</button></div></div></div>

<script>
    // --- C·∫§U H√åNH KH√ìA D·ªÆ LI·ªÜU ---
    const KEYS = { STOCK: 'inventory_stock', ORDERS: 'daily_orders', CUSTOMERS: 'customer_list', STAFF: 'sales_staff', SUPPLIERS: 'suppliers_list', CASHFLOW: 'cashflow_data' };
    
    // --- C·∫§U H√åNH GOOGLE SHEETS (Thay URL c·ªßa b·∫°n v√†o ƒë√¢y) ---
    const GOOGLE_SCRIPT_URL = 'THAY_LINK_WEB_APP_CUA_BAN_VAO_DAY'; 

    // --- H√ÄM TI·ªÜN √çCH ---
    const loadData = (key) => { try { return JSON.parse(localStorage.getItem(key)) || []; } catch { return []; } };
    const saveData = (key, data) => localStorage.setItem(key, JSON.stringify(data));
    const formatCurrency = (n, short=false) => { 
        if(short && n >= 1000000) return (n/1000000).toFixed(1) + 'M';
        if(short && n >= 1000) return (n/1000).toFixed(1) + 'k';
        return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(n || 0);
    };
    const generateID = () => 'PXK' + Date.now().toString().slice(-8);
    
    let editingOrderId = null;

    // --- KH·ªûI T·∫†O ---
    document.addEventListener('DOMContentLoaded', () => { 
        switchTab('tab-sales'); 
        const today = new Date().toISOString().slice(0, 10);
        ['cfDate', 'orderDate', 'importDate', 'filterStart', 'filterEnd'].forEach(id => {
            const el = document.getElementById(id); if(el) el.value = today;
        });
        document.getElementById('fileInput')?.addEventListener('change', handleFileImport);
        document.getElementById('cashflowForm')?.addEventListener('submit', handleCashflowSubmit);
        document.getElementById('addStaffForm')?.addEventListener('submit', handleAddStaff);
        document.getElementById('addSupplierForm')?.addEventListener('submit', handleAddSupplier);
    });

    const switchTab = (tabId) => {
        const tabEl = document.getElementById(tabId); if(!tabEl) return; 
        document.querySelectorAll('.tab-pane').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        tabEl.classList.add('active');
        const map = {'tab-sales':0, 'tab-cashflow':1, 'tab-customers':2, 'tab-staff':3, 'tab-inventory':4, 'tab-reports':5};
        if(map[tabId] !== undefined) document.querySelectorAll('.nav-item')[map[tabId]].classList.add('active');
        
        if(tabId === 'tab-sales') { populateStaffSelect(); updateProductDatalist('productListSales'); if(!editingOrderId) createOrderItemRow(); updateInvoicePreview(); }
        if(tabId === 'tab-cashflow') { renderCashflow(); updateOrderDatalist(); }
        if(tabId === 'tab-customers') renderCrmSidebar();
        if(tabId === 'tab-staff') renderStaff();
        if(tabId === 'tab-inventory') { renderSuppliers(); populateSupplierSelect(); renderInventory(); updateProductDatalist('productListStock'); createStockRow(); }
        if(tabId === 'tab-reports') filterReports(currentReportPeriod || 'today'); 
    };

    // --- GOOGLE SHEETS SYNC ---
    const syncWithGoogleSheets = async () => {
        if(GOOGLE_SCRIPT_URL.includes('THAY_LINK')) {
            alert('B·∫°n ch∆∞a c·∫•u h√¨nh link Google Apps Script trong code!');
            return;
        }
        if(!confirm('H√†nh ƒë·ªông n√†y s·∫Ω nh·∫≠p th√™m h√†ng t·ª´ Google Sheets v√†o kho hi·ªán t·∫°i. Ti·∫øp t·ª•c?')) return;
        try {
            const btn = event.target; const oldText = btn.textContent;
            btn.textContent = "‚è≥ ƒêang t·∫£i..."; btn.disabled = true;
            const response = await fetch(GOOGLE_SCRIPT_URL);
            const data = await response.json();
            let stock = loadData(KEYS.STOCK); let count = 0;
            data.forEach(item => {
                if(item.name && item.qty > 0) {
                    let exist = stock.find(s => s.name === item.name && parseFloat(s.costPrice) === parseFloat(item.cost));
                    if(exist) { exist.quantityIn += parseInt(item.qty); if(item.supplier) exist.supplier = item.supplier; } 
                    else { stock.push({ name: item.name, quantityIn: parseInt(item.qty), quantityOut: 0, costPrice: parseFloat(item.cost), supplier: item.supplier || '', note: 'Nh·∫≠p t·ª´ Sheets' }); }
                    count++;
                }
            });
            saveData(KEYS.STOCK, stock); renderInventory(); updateProductDatalist('productListStock');
            alert(`ƒê√£ ƒë·ªìng b·ªô th√†nh c√¥ng ${count} d√≤ng d·ªØ li·ªáu t·ª´ Sheet!`);
            btn.textContent = oldText; btn.disabled = false;
        } catch (error) { console.error(error); alert('L·ªói k·∫øt n·ªëi Google Sheets!'); event.target.textContent = "‚òÅÔ∏è ƒê·ªìng b·ªô t·ª´ Sheet"; event.target.disabled = false; }
    };

    // --- LOGIC CRM (KH√ÅCH H√ÄNG) ---
    const renderCrmSidebar = () => {
        const listDiv = document.getElementById('crmCustomerList');
        const term = document.getElementById('crmSearch').value.toLowerCase().trim();
        let customers = loadData(KEYS.CUSTOMERS);
        
        if (term) customers = customers.filter(c => c.phone.includes(term) || c.name.toLowerCase().includes(term));
        
        if(customers.length === 0) { 
            listDiv.innerHTML = '<div style="padding:15px;text-align:center;color:#999">Ch∆∞a c√≥ kh√°ch h√†ng</div>'; 
            return; 
        }
        
        // S·∫Øp x·∫øp kh√°ch h√†ng m·ªõi l√™n ƒë·∫ßu
        customers.reverse();

        listDiv.innerHTML = customers.map(c => `
            <div class="cust-item" onclick="viewCustomerDetail('${c.phone}')">
                <div class="cust-name">${c.name}</div>
                <div class="cust-phone">
                    <span style="color:#666">üì± ${c.phone}</span>
                </div>
            </div>
        `).join('');
    };

    const viewCustomerDetail = (phone) => {
        // 1. T√¨m th√¥ng tin kh√°ch
        const customers = loadData(KEYS.CUSTOMERS); 
        const customer = customers.find(c => c.phone === phone); 
        if (!customer) {
            console.error("Kh√¥ng t√¨m th·∫•y kh√°ch h√†ng v·ªõi SƒêT:", phone);
            return;
        }

        // Highlight giao di·ªán b√™n tr√°i
        document.querySelectorAll('.cust-item').forEach(el => el.classList.remove('active')); 
        event.currentTarget.classList.add('active');
        
        // 2. L·∫•y d·ªØ li·ªáu ƒë∆°n h√†ng c·ªßa kh√°ch
        const allOrders = loadData(KEYS.ORDERS);
        // L·ªçc ƒë∆°n h√†ng c√≥ sdt tr√πng kh·ªõp (trim ƒë·ªÉ ƒë·∫£m b·∫£o kh√¥ng l·ªói kho·∫£ng tr·∫Øng)
        const orders = allOrders.filter(o => o.customer.phone.trim() === phone.trim());
        
        // S·∫Øp x·∫øp ƒë∆°n m·ªõi nh·∫•t l√™n ƒë·∫ßu
        orders.sort((a, b) => new Date(b.date) - new Date(a.date));

        const totalSpent = orders.reduce((sum, o) => sum + o.totalAmount, 0);

        // 3. Render giao di·ªán chi ti·∫øt b√™n ph·∫£i
        const detailDiv = document.getElementById('crmDetailView');
        detailDiv.innerHTML = `
            <div class="card" style="border-top: 5px solid var(--primary-color);">
                <div style="display:flex; justify-content:space-between; align-items:flex-start">
                    <div>
                        <h2 style="margin:0; color: #333">${customer.name}</h2>
                        <div style="color:#666; margin-top:5px; font-size: 14px;">
                            <div>üìç ƒê·ªãa ch·ªâ: <strong>${customer.address || 'Ch∆∞a c·∫≠p nh·∫≠t'}</strong></div>
                            <div>üìû ƒêi·ªán tho·∫°i: <strong>${customer.phone}</strong></div>
                        </div>
                    </div>
                    <div style="text-align:right">
                        <button class="btn btn-warning btn-sm" onclick="startOrderForCustomer('${customer.phone}', '${customer.name}', '${customer.address}')">üõí T·∫°o ƒë∆°n m·ªõi</button>
                    </div>
                </div>

                <hr style="border:0; border-top:1px solid #eee; margin: 15px 0;">

                <div class="crm-info-box">
                    <div class="crm-stat-card">
                        <h4>T·ªïng Chi Ti√™u</h4>
                        <div>${formatCurrency(totalSpent)}</div>
                    </div>
                    <div class="crm-stat-card">
                        <h4>S·ªë ƒê∆°n H√†ng</h4>
                        <div style="color:var(--info-color)">${orders.length}</div>
                    </div>
                    <div class="crm-stat-card">
                        <h4>L·∫ßn Cu·ªëi Mua</h4>
                        <div style="color:#666; font-size:16px; margin-top:3px;">${orders.length > 0 ? new Date(orders[0].date).toLocaleDateString('vi-VN') : 'Ch∆∞a mua'}</div>
                    </div>
                </div>
            </div>

            <h4 style="margin: 20px 0 10px 0; color: var(--primary-color);">üìú L·ªãch s·ª≠ mua h√†ng</h4>
            <div class="card">
                <table class="table">
                    <thead>
                        <tr>
                            <th>M√£ ƒêH</th>
                            <th>Ng√†y mua</th>
                            <th>S·∫£n ph·∫©m</th>
                            <th class="text-right">T·ªïng ti·ªÅn</th>
                            <th class="text-center">Chi ti·∫øt</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${orders.length > 0 ? orders.map(o => {
                            // T√≥m t·∫Øt t√™n s·∫£n ph·∫©m
                            const summary = o.items.map(i => `${i.name.split('{')[0]} (x${i.quantity})`).join(', ');
                            return `
                                <tr>
                                    <td><span style="font-weight:bold; color:var(--primary-color)">${o.id}</span></td>
                                    <td>${new Date(o.date).toLocaleDateString('vi-VN')}</td>
                                    <td style="max-width:250px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis" title="${summary}">${summary}</td>
                                    <td class="text-right" style="font-weight:bold">${formatCurrency(o.totalAmount)}</td>
                                    <td class="text-center">
                                        <button class="btn btn-secondary btn-sm" onclick="startEditOrder('${o.id}')">Xem/S·ª≠a</button>
                                    </td>
                                </tr>
                            `;
                        }).join('') : '<tr><td colspan="5" class="text-center" style="padding:20px; color:#999">Ch∆∞a c√≥ ƒë∆°n h√†ng n√†o ƒë∆∞·ª£c ghi nh·∫≠n.</td></tr>'}
                    </tbody>
                </table>
            </div>
        `;
    };
    
    // H√†m ph·ª• tr·ª£: Nh·∫£y sang tab b√°n h√†ng v√† ƒëi·ªÅn s·∫µn th√¥ng tin kh√°ch
    const startOrderForCustomer = (phone, name, addr) => {
        switchTab('tab-sales');
        document.getElementById('custPhone').value = phone;
        document.getElementById('custName').value = name;
        document.getElementById('custAddress').value = addr || '';
        updateInvoicePreview();
    };

    // --- LOGIC B√ÅN H√ÄNG & L∆ØU ƒê∆†N (UPDATED) ---
    const submitOrder = () => {
        const rows = document.querySelectorAll('#orderItemsBody tr');
        let items = [], totalCost = 0, totalRev = 0; let stockData = loadData(KEYS.STOCK);
        for(let row of rows) { 
            const inputName = row.querySelector('.item-name').value; 
            const qty = parseFloat(row.querySelector('.item-qty').value); 
            const price = parseFloat(row.querySelector('.item-price').value); 
            if(!inputName || qty <= 0) { alert('Ki·ªÉm tra l·∫°i t√™n SP ho·∫∑c S·ªë l∆∞·ª£ng!'); return; } 
            const prod = stockData.find(s => `${s.name} {V:${s.costPrice}}` === inputName);
            if(prod) { totalCost += (qty * prod.costPrice); } 
            items.push({name: inputName, quantity: qty, price}); totalRev += (qty * price); 
        }
        if(items.length === 0) return; 
        const ship = parseFloat(document.getElementById('shippingCost').value)||0;
        const custName = document.getElementById('custName').value.trim();
        const custPhone = document.getElementById('custPhone').value.trim();
        const custAddr = document.getElementById('custAddress').value.trim();
        const staffName = document.getElementById('saleStaffSelect').value;
        if(!custPhone) { alert("Vui l√≤ng nh·∫≠p SƒêT Kh√°ch h√†ng!"); return; }
        const selectedDate = document.getElementById('orderDate').value;
        const orderDate = selectedDate ? new Date(selectedDate).toISOString() : new Date().toISOString();
        const order = { id: document.getElementById('invID').textContent, date: orderDate, customer: { name: custName, phone: custPhone, address: custAddr }, staff: staffName, items, shipping: ship, totalAmount: totalRev + ship, cost: totalCost };
        
        let orders = loadData(KEYS.ORDERS);
        if(editingOrderId) { 
            const oldIdx = orders.findIndex(o => o.id === editingOrderId);
            if (oldIdx !== -1) {
                orders[oldIdx].items.forEach(i => { const p = stockData.find(s => `${s.name} {V:${s.costPrice}}` === i.name); if(p) p.quantityOut -= i.quantity; }); 
                items.forEach(i => { const p = stockData.find(s => `${s.name} {V:${s.costPrice}}` === i.name); if(p) p.quantityOut += i.quantity; }); 
                orders[oldIdx] = order; alert('C·∫≠p nh·∫≠t ƒë∆°n h√†ng th√†nh c√¥ng!'); 
            }
        } else { 
            items.forEach(i => { const p = stockData.find(s => `${s.name} {V:${s.costPrice}}` === i.name); if(p) p.quantityOut += i.quantity; }); 
            orders.push(order); alert('L∆∞u ƒë∆°n m·ªõi th√†nh c√¥ng!'); 
        }

        // C·∫≠p nh·∫≠t CRM (Logic s·ª≠a: T√¨m ƒë√∫ng SƒêT ƒë·ªÉ update ho·∫∑c th√™m m·ªõi)
        let customers = loadData(KEYS.CUSTOMERS);
        let existingCustIndex = customers.findIndex(c => c.phone === custPhone);
        if (existingCustIndex >= 0) { 
            customers[existingCustIndex].name = custName; 
            customers[existingCustIndex].address = custAddr; 
        } else { 
            customers.push({name: custName, phone: custPhone, address: custAddr, note: ''}); 
        }
        saveData(KEYS.CUSTOMERS, customers);

        saveData(KEYS.STOCK, stockData); saveData(KEYS.ORDERS, orders); cancelEditOrder();
    };

    // --- C√ÅC LOGIC KH√ÅC GI·ªÆ NGUY√äN ---
    let currentReportPeriod = 'today'; 
    const toggleCustomFilter = () => { const area = document.getElementById('customFilterArea'); const btn = document.getElementById('btn-custom'); if (area.classList.contains('active')) { area.classList.remove('active'); btn.classList.remove('btn-primary'); btn.classList.add('btn-secondary'); } else { area.classList.add('active'); } };
    const filterReports = (period) => {
        currentReportPeriod = period;
        ['btn-today','btn-week','btn-month','btn-year','btn-all', 'btn-custom'].forEach(id=>{ const btn = document.getElementById(id); if(btn) { btn.classList.remove('btn-primary'); btn.classList.add('btn-secondary'); } });
        if (period === 'custom') { document.getElementById('btn-custom').classList.add('btn-primary'); document.getElementById('customFilterArea').classList.add('active'); } 
        else { const activeBtn = document.getElementById('btn-'+period); if(activeBtn) { activeBtn.classList.remove('btn-secondary'); activeBtn.classList.add('btn-primary'); } document.getElementById('customFilterArea').classList.remove('active'); }
        let startDate, endDate; const now = new Date(); now.setHours(0,0,0,0);
        if (period === 'today') { startDate = new Date(now); endDate = new Date(now); endDate.setHours(23,59,59,999); } 
        else if (period === 'week') { startDate = new Date(now); startDate.setDate(now.getDate() - now.getDay() + 1); endDate = new Date(now); endDate.setHours(23,59,59,999); } 
        else if (period === 'month') { startDate = new Date(now.getFullYear(), now.getMonth(), 1); endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59); } 
        else if (period === 'year') { startDate = new Date(now.getFullYear(), 0, 1); endDate = new Date(now.getFullYear(), 11, 31, 23, 59, 59); } 
        else if (period === 'all') { startDate = new Date(1970, 0, 1); endDate = new Date(2100, 0, 1); } 
        else if (period === 'custom') { const s = document.getElementById('filterStart').value; const e = document.getElementById('filterEnd').value; if(!s || !e) { alert('Vui l√≤ng ch·ªçn ng√†y!'); return; } startDate = new Date(s); startDate.setHours(0,0,0,0); endDate = new Date(e); endDate.setHours(23,59,59,999); }
        const checkDate = (dateStr) => { if(!dateStr) return false; const d = new Date(dateStr); return d >= startDate && d <= endDate; };
        const orders = loadData(KEYS.ORDERS).filter(o => checkDate(o.date));
        const cashflow = loadData(KEYS.CASHFLOW).filter(c => checkDate(c.date));
        let totalRev = 0, totalCOGS = 0; orders.forEach(o => { totalRev += o.totalAmount; totalCOGS += (o.cost || 0); });
        let otherIncome = 0, totalExpense = 0; const rptGenExpTable = document.getElementById('rptGenExpTable').querySelector('tbody'); rptGenExpTable.innerHTML = '';
        cashflow.forEach(c => { if(c.type === 'THU') { otherIncome += c.amount; } else { totalExpense += c.amount; rptGenExpTable.innerHTML += `<tr><td>${new Date(c.date).toLocaleDateString('vi-VN')}</td><td>${c.category}</td><td class="text-right" style="color:red">${formatCurrency(c.amount)}</td></tr>`; } });
        const grossProfit = totalRev - totalCOGS; const netProfit = grossProfit + otherIncome - totalExpense; 
        document.getElementById('kpiRevenue').textContent = formatCurrency(totalRev);
        const stockData = loadData(KEYS.STOCK); const totalImport = stockData.reduce((sum, s) => sum + (s.quantityIn * s.costPrice), 0);
        document.getElementById('kpiTotalImport').textContent = formatCurrency(totalImport); document.getElementById('kpiTotalExpense').textContent = formatCurrency(totalExpense); document.getElementById('kpiNetProfit').textContent = formatCurrency(netProfit); document.getElementById('kpiNetProfit').style.color = netProfit >= 0 ? 'var(--success-color)' : 'var(--danger-color)';
        document.getElementById('rptRev').textContent = formatCurrency(totalRev); document.getElementById('rptCOGS').textContent = formatCurrency(totalCOGS); document.getElementById('rptGrossProfit').textContent = formatCurrency(grossProfit); document.getElementById('rptOtherInc').textContent = formatCurrency(otherIncome); document.getElementById('rptOtherExp').textContent = formatCurrency(totalExpense); document.getElementById('rptNetProfit').textContent = formatCurrency(netProfit);
        const margin = totalRev > 0 ? (netProfit / totalRev) * 100 : 0; document.getElementById('profitMargin').textContent = margin.toFixed(1) + '%'; document.getElementById('barProfit').style.width = Math.min(Math.max(margin, 0), 100) + '%';
        const tb = document.getElementById('rptOrdersTable').querySelector('tbody'); tb.innerHTML = ''; orders.forEach(o => { const oNet = (o.totalAmount - (o.cost||0)); tb.innerHTML += `<tr><td>${o.customer.name}</td><td>${o.id}</td><td>${new Date(o.date).toLocaleDateString('vi-VN')}</td><td class="text-right">${formatCurrency(o.totalAmount)}</td><td class="text-right">${formatCurrency(oNet)}</td><td><button class="btn btn-warning btn-sm" onclick="startEditOrder('${o.id}')">S·ª≠a</button> <button class="btn btn-danger btn-sm" onclick="deleteOrder('${o.id}')">H·ªßy</button></td></tr>`; });
        const tbOrderExp = document.getElementById('rptOrderExpTable').querySelector('tbody'); tbOrderExp.innerHTML = ''; orders.filter(o => o.shipping !== 0).forEach(o => { tbOrderExp.innerHTML += `<tr><td>${o.id}</td><td class="text-right">${formatCurrency(Math.abs(o.shipping))}</td><td>${o.shipping > 0 ? 'Thu ship' : 'Tr·ª£ gi√° ship'}</td></tr>`; });
        drawCharts(orders);
    };

    const submitStockEntry = () => { const supplier = document.getElementById('stockSupplier').value; if (!supplier) { alert('Ch·ªçn NCC!'); return; } const rows = document.querySelectorAll('#stockEntryBody tr'); let stock = loadData(KEYS.STOCK); let count = 0; rows.forEach(row => { const name = row.querySelector('.stock-name').value.trim(); const qty = parseInt(row.querySelector('.stock-qty').value); const cost = parseFloat(row.querySelector('.stock-cost').value); const note = row.querySelector('.stock-note').value; if(name && qty > 0) { let item = stock.find(s => s.name === name && parseFloat(s.costPrice) === cost); if(item) { item.quantityIn += qty; item.supplier = supplier; item.note = note || item.note; } else { stock.push({name, quantityIn: qty, quantityOut: 0, costPrice: cost, supplier, note}); } count++; } }); if(count > 0) { saveData(KEYS.STOCK, stock); alert(`Nh·∫≠p ${count} m√£ h√†ng th√†nh c√¥ng!`); document.getElementById('stockEntryBody').innerHTML = ''; createStockRow(); renderInventory(); updateProductDatalist('productListStock'); } };
    const updateProductDatalist = (el) => { const stock = loadData(KEYS.STOCK); const list = document.getElementById(el); if(list) { list.innerHTML = stock.map(s => `<option value="${s.name} {V:${s.costPrice}}">T·ªìn: ${s.quantityIn - s.quantityOut} - V·ªën: ${formatCurrency(s.costPrice)}</option>`).join(''); } }
    const updateInvoicePreview = () => { const id = editingOrderId || (document.getElementById('orderIDDisplay')?.value || generateID()); document.getElementById('invID').textContent = id; const inputDate = document.getElementById('orderDate').value; document.getElementById('invDate').textContent = inputDate ? new Date(inputDate).toLocaleDateString('vi-VN') : new Date().toLocaleDateString('vi-VN'); const staffSel = document.getElementById('saleStaffSelect'); document.getElementById('invStaff').textContent = staffSel.value || '...'; const s = loadData(KEYS.STAFF).find(x => x.name === staffSel.value); document.getElementById('invStaffPhone').textContent = s ? s.phone : '...'; document.getElementById('invCustName').textContent = document.getElementById('custName').value || '...'; document.getElementById('invCustPhone').textContent = document.getElementById('custPhone').value || '...'; document.getElementById('invCustAddr').textContent = document.getElementById('custAddress').value || '...'; let subTotal = 0, htmlRows = '', stt = 1; document.querySelectorAll('#orderItemsBody tr').forEach(row => { const rawName = row.querySelector('.item-name').value; const displayName = rawName.split(' {V:')[0]; const qty = parseFloat(row.querySelector('.item-qty').value)||0; const price = parseFloat(row.querySelector('.item-price').value)||0; const total = qty * price; if(rawName) { subTotal += total; htmlRows += `<tr><td class="text-center">${stt++}</td><td>${displayName}</td><td class="text-center">C√°i</td><td class="text-center">${qty}</td><td class="text-right">${formatCurrency(price).replace('‚Ç´','')}</td><td class="text-right">${formatCurrency(total).replace('‚Ç´','')}</td></tr>`; } }); document.getElementById('invItemsList').innerHTML = htmlRows; document.getElementById('invSubTotal').textContent = formatCurrency(subTotal); const ship = parseFloat(document.getElementById('shippingCost').value)||0; document.getElementById('invShip').textContent = formatCurrency(ship); document.getElementById('invTotal').textContent = formatCurrency(subTotal+ship); document.getElementById('invTotalText').textContent = "(B·∫±ng ch·ªØ)"; };
    const createOrderItemRow = (p='', q=1, pr=0) => {const tbody = document.getElementById('orderItemsBody'); const row = tbody.insertRow(); row.innerHTML = `<td><input type="text" class="form-control item-name" list="productListSales" value="${p}" placeholder="G√µ t√™n..." onchange="updateInvoicePreview()"></td><td><input type="number" class="form-control item-qty" value="${q}" oninput="updateInvoicePreview()"></td><td><input type="number" class="form-control item-price" value="${pr||''}" placeholder="0" oninput="updateInvoicePreview()"></td><td><button class="btn btn-danger btn-sm" onclick="this.closest('tr').remove(); updateInvoicePreview()">x</button></td>`;};
    const startEditOrder = (id) => { const o = loadData(KEYS.ORDERS).find(x=>x.id===id); if(!o) return; switchTab('tab-sales'); editingOrderId = id; document.getElementById('editModeBanner').style.display='block'; document.getElementById('editingOrderIDText').textContent = id; document.getElementById('btnSaveOrder').textContent = "üíæ C·∫¨P NH·∫¨T"; document.getElementById('btnSaveOrder').classList.replace('btn-primary','btn-warning'); document.getElementById('btnCancelEdit').style.display = 'inline-block'; document.getElementById('custPhone').value = o.customer.phone; document.getElementById('custName').value = o.customer.name; document.getElementById('custAddress').value = o.customer.address; document.getElementById('shippingCost').value = o.shipping; const sel = document.getElementById('saleStaffSelect'); sel.value = o.staff; document.getElementById('orderItemsBody').innerHTML=''; o.items.forEach(i=>createOrderItemRow(i.name, i.quantity, i.price)); if(o.date) document.getElementById('orderDate').value = new Date(o.date).toISOString().slice(0,10); updateInvoicePreview(); }
    const cancelEditOrder = () => { editingOrderId = null; document.getElementById('editModeBanner').style.display='none'; document.getElementById('btnSaveOrder').textContent = "‚úÖ L∆ØU ƒê∆†N"; document.getElementById('btnSaveOrder').classList.replace('btn-warning','btn-primary'); document.getElementById('btnCancelEdit').style.display='none'; document.getElementById('custPhone').value=''; document.getElementById('custName').value=''; document.getElementById('custAddress').value=''; document.getElementById('shippingCost').value=0; document.getElementById('orderItemsBody').innerHTML=''; createOrderItemRow(); document.getElementById('orderDate').value = new Date().toISOString().slice(0,10); updateInvoicePreview(); }
    const renderCashflow = () => { const list = loadData(KEYS.CASHFLOW); const tbody = document.getElementById('cashflowTable').querySelector('tbody'); tbody.innerHTML = ''; list.forEach((item, index) => { const color = item.type === 'THU' ? 'green' : 'red'; tbody.innerHTML += `<tr><td>${new Date(item.date).toLocaleDateString('vi-VN')}</td><td style="font-weight:bold; color:${color}">${item.type}</td><td style="font-weight:bold; color:${color}">${formatCurrency(item.amount)}</td><td>${item.orderId || '-'}</td><td>${item.category}</td><td>${item.note || ''}</td><td><button class="btn btn-danger btn-sm" onclick="delCashflow(${index})">X</button></td></tr>`; }); };
    const handleCashflowSubmit = (e) => { e.preventDefault(); const data = { date: document.getElementById('cfDate').value, type: document.getElementById('cfType').value, amount: parseFloat(document.getElementById('cfAmount').value), orderId: document.getElementById('cfOrderId').value, category: document.getElementById('cfCategory').value, note: document.getElementById('cfNote').value }; let list = loadData(KEYS.CASHFLOW); list.push(data); saveData(KEYS.CASHFLOW, list); alert('ƒê√£ l∆∞u phi·∫øu!'); document.getElementById('cashflowForm').reset(); document.getElementById('cfDate').valueAsDate = new Date(); renderCashflow(); };
    const delCashflow = (index) => { if(confirm('X√≥a phi·∫øu n√†y?')) { let list = loadData(KEYS.CASHFLOW); list.splice(index, 1); saveData(KEYS.CASHFLOW, list); renderCashflow(); } };
    const createStockRow = () => { const tbody = document.getElementById('stockEntryBody'); if(tbody.innerHTML.trim() === '' || event?.type === 'click') { const row = tbody.insertRow(); row.innerHTML = `<td><input type="text" class="form-control stock-name" list="productListStock" placeholder="T√™n SP" onchange="fillStockInfo(this)"></td><td><input type="number" class="form-control stock-qty" min="1" value="1"></td><td><input type="number" class="form-control stock-cost" min="0" placeholder="0"></td><td><input type="text" class="form-control stock-note" placeholder="Ghi ch√∫"></td><td><button class="btn btn-danger btn-sm" onclick="this.closest('tr').remove()">x</button></td>`; } };
    const fillStockInfo = (input) => { const name = input.value; const stock = loadData(KEYS.STOCK).find(s => s.name === name); if(stock) input.closest('tr').querySelector('.stock-cost').value = stock.costPrice; };
    const renderInventory = () => { const filterSup = document.getElementById('filterSupplier')?.value; let stock = loadData(KEYS.STOCK); if(filterSup) stock = stock.filter(s => s.supplier === filterSup); const tbody = document.getElementById('inventoryTable').querySelector('tbody'); tbody.innerHTML = ''; stock.forEach((s, i) => { const avail = s.quantityIn - s.quantityOut; tbody.innerHTML += `<tr><td><input class="editable-input" value="${s.name}" onchange="updateStock(${i}, 'name', this.value)"></td><td><input class="editable-input" list="stockSupplierList" value="${s.supplier||''}" onchange="updateStock(${i}, 'supplier', this.value)"></td><td><input type="number" class="editable-input" style="width:60px" value="${s.quantityIn}" onchange="updateStock(${i}, 'quantityIn', this.value)"></td><td><input type="number" class="editable-input" style="width:60px" value="${s.quantityOut}" onchange="updateStock(${i}, 'quantityOut', this.value)"></td><td style="font-weight:bold; color:${avail<5?'red':'green'}">${avail}</td><td><input type="number" class="editable-input" value="${s.costPrice}" onchange="updateStock(${i}, 'costPrice', this.value)"></td><td>${s.note||''}</td><td><button class="btn btn-danger btn-sm" onclick="delItem(KEYS.STOCK, ${i}, 'renderInventory')">X</button></td></tr>`; }); if(!document.getElementById('stockSupplierList')) { const dl = document.createElement('datalist'); dl.id = 'stockSupplierList'; loadData(KEYS.SUPPLIERS).forEach(sup => { const op = document.createElement('option'); op.value = sup.name; dl.appendChild(op); }); document.body.appendChild(dl); } };
    const updateStock = (idx, field, val) => { let s = loadData(KEYS.STOCK); if(field === 'quantityIn' || field === 'quantityOut' || field === 'costPrice') { s[idx][field] = parseFloat(val) || 0; } else { s[idx][field] = val; } saveData(KEYS.STOCK, s); renderInventory(); };
    const sortInventory = (type) => { let stock = loadData(KEYS.STOCK); if(type === 'stock') stock.sort((a,b) => (b.quantityIn - b.quantityOut) - (a.quantityIn - a.quantityOut)); if(type === 'sold') stock.sort((a,b) => b.quantityOut - a.quantityOut); const tbody = document.getElementById('inventoryTable').querySelector('tbody'); tbody.innerHTML = ''; stock.forEach((s) => { const avail = s.quantityIn - s.quantityOut; tbody.innerHTML += `<tr><td>${s.name}</td><td>${s.supplier}</td><td>${s.quantityIn}</td><td>${s.quantityOut}</td><td style="font-weight:bold">${avail}</td><td>${formatCurrency(s.costPrice)}</td><td>${s.note}</td><td>-</td></tr>`; }); };
    const renderSuppliers = () => { const tb = document.getElementById('supplierTable').querySelector('tbody'); tb.innerHTML = ''; const term = document.getElementById('searchSupplier')?.value.toLowerCase() || ''; let suppliers = loadData(KEYS.SUPPLIERS); if (term) suppliers = suppliers.filter(s => s.name.toLowerCase().includes(term)); suppliers.forEach((s, i) => { tb.innerHTML += `<tr><td><input class="editable-input" value="${s.name}" onchange="updSupp(${i},'name',this.value)"></td><td>${s.phone||''}</td><td>${s.address||''}</td><td><button class="btn btn-danger btn-sm" onclick="delItem(KEYS.SUPPLIERS,${i},'renderSuppliers')">X</button></td></tr>`; }); };
    const searchOrderTable = () => { const term = document.getElementById('searchOrderReport').value.toLowerCase(); document.querySelectorAll('#rptOrdersTable tbody tr').forEach(r => { r.style.display = r.innerText.toLowerCase().includes(term) ? '' : 'none'; }); };
    const delItem=(key,idx,renderFunc)=>{if(confirm('X√≥a?')){let d=loadData(key);d.splice(idx,1);saveData(key,d);window[renderFunc]();}}
    const updSupp=(i,f,v)=>{let s=loadData(KEYS.SUPPLIERS);s[i][f]=v;saveData(KEYS.SUPPLIERS,s);populateSupplierSelect();}
    const populateSupplierSelect=()=>{const sel=document.getElementById('stockSupplier');const filter=document.getElementById('filterSupplier'); let html='<option value="">-- Ch·ªçn NCC --</option>'; loadData(KEYS.SUPPLIERS).forEach(s=>{html+=`<option value="${s.name}">${s.name}</option>`}); sel.innerHTML=html; if(filter) filter.innerHTML='<option value="">T·∫•t c·∫£ NCC</option>'+html;}
    const handleAddSupplier = (e)=>{e.preventDefault();let s=loadData(KEYS.SUPPLIERS);s.push({name:document.getElementById('suppName').value,phone:document.getElementById('suppPhone').value,address:document.getElementById('suppAddr').value});saveData(KEYS.SUPPLIERS,s);e.target.reset();renderSuppliers();populateSupplierSelect();};
    const renderStaff=()=>{const tb=document.getElementById('staffTable').querySelector('tbody');tb.innerHTML='';loadData(KEYS.STAFF).forEach((s,i)=>{tb.innerHTML+=`<tr><td>${s.name}</td><td>${s.phone}</td><td>${s.address}</td><td>${s.note||''}</td><td><button class="btn btn-danger btn-sm" onclick="delItem(KEYS.STAFF,${i},'renderStaff')">X</button></td></tr>`});}
    const handleAddStaff = (e)=>{e.preventDefault();let s=loadData(KEYS.STAFF);s.push({name:document.getElementById('staffName').value,phone:document.getElementById('staffPhone').value,address:document.getElementById('staffAddress').value,note:document.getElementById('staffNote').value});saveData(KEYS.STAFF,s);e.target.reset();renderStaff();};
    const populateStaffSelect=()=>{const sel=document.getElementById('saleStaffSelect');sel.innerHTML='<option value="">--Ch·ªçn Sales--</option>';loadData(KEYS.STAFF).forEach(s=>sel.innerHTML+=`<option value="${s.name}">${s.name}</option>`);}
    const findCustomerByPhone=()=>{const p=document.getElementById('custPhone').value;const c=loadData(KEYS.CUSTOMERS).find(x=>x.phone===p);if(c){document.getElementById('custName').value=c.name;document.getElementById('custAddress').value=c.address;updateInvoicePreview();}}
    const deleteOrder = (id) => { if(!confirm('H·ªßy ƒë∆°n v√† ho√†n kho?')) return; let orders=loadData(KEYS.ORDERS); const idx=orders.findIndex(o=>o.id===id); if(idx===-1)return; let stock=loadData(KEYS.STOCK); orders[idx].items.forEach(i=>{let p=stock.find(s=>`${s.name} {V:${s.costPrice}}`===i.name); if(p)p.quantityOut-=i.quantity;}); orders.splice(idx,1); saveData(KEYS.STOCK,stock); saveData(KEYS.ORDERS,orders); alert('ƒê√£ h·ªßy ƒë∆°n'); filterReports(currentReportPeriod || 'today'); };
    const exportData = () => { try { const data = {}; for (let k in KEYS) data[k] = loadData(KEYS[k]); const blob = new Blob([JSON.stringify(data)], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `backup_pro_${new Date().toISOString().slice(0,10)}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); } catch (err) { alert('L·ªói sao l∆∞u: ' + err.message); } };
    const handleFileImport = (e) => { const f = e.target.files[0]; if (!f) return; const r = new FileReader(); r.onload = (ev) => { try { const d = JSON.parse(ev.target.result); if (confirm('C·∫£nh b√°o: D·ªØ li·ªáu hi·ªán t·∫°i s·∫Ω b·ªã thay th·∫ø b·ªüi b·∫£n sao l∆∞u. Ti·∫øp t·ª•c?')) { for (let k in KEYS) { if (d[k]) saveData(KEYS[k], d[k]); } alert('Ph·ª•c h·ªìi th√†nh c√¥ng!'); location.reload(); } } catch (err) { alert('File kh√¥ng h·ª£p l·ªá!'); } }; r.readAsText(f); };
    const updateOrderDatalist = () => { const orders = loadData(KEYS.ORDERS); const datalist = document.getElementById('orderListSuggestions'); if (datalist) { const sortedOrders = orders.sort((a, b) => new Date(b.date) - new Date(a.date)); datalist.innerHTML = sortedOrders.map(o => `<option value="${o.id}">Kh√°ch: ${o.customer.name} - ${formatCurrency(o.totalAmount)}</option>`).join(''); } };
    const drawCharts = (orders) => { const salesMap = {}; orders.forEach(o => { const name = o.staff || 'Ch∆∞a g√°n'; if(!salesMap[name]) salesMap[name] = 0; salesMap[name] += o.totalAmount; }); const sortedSales = Object.entries(salesMap).sort((a,b)=>b[1]-a[1]).slice(0, 5); const maxSalesVal = sortedSales.length > 0 ? sortedSales[0][1] : 1; document.getElementById('chartTopSales').innerHTML = `<div class="chart-container">` + sortedSales.map(([name, val]) => { const percent = (val / maxSalesVal) * 100; return `<div class="chart-column"><div class="chart-bar" style="height:${percent}%; background-color:var(--primary-color)" title="${name}: ${formatCurrency(val)}"><div class="chart-value">${formatCurrency(val, true)}</div></div><div class="chart-label">${name}</div></div>`; }).join('') + `</div>` || '<p class="text-center">Ch∆∞a c√≥ d·ªØ li·ªáu</p>'; const custMap = {}; orders.forEach(o => { const phone = o.customer.phone || 'passerby'; if(!custMap[phone]) custMap[phone] = {name: o.customer.name, val:0}; custMap[phone].val += o.totalAmount; }); const sortedCust = Object.values(custMap).sort((a,b)=>b.val-a.val).slice(0, 5); const maxCustVal = sortedCust.length > 0 ? sortedCust[0].val : 1; document.getElementById('chartTopCustomers').innerHTML = `<div class="chart-container">` + sortedCust.map(c => { const percent = (c.val / maxCustVal) * 100; return `<div class="chart-column"><div class="chart-bar" style="height:${percent}%; background-color:var(--success-color)" title="${c.name}: ${formatCurrency(c.val)}"><div class="chart-value">${formatCurrency(c.val, true)}</div></div><div class="chart-label">${c.name}</div></div>`; }).join('') + `</div>` || '<p class="text-center">Ch∆∞a c√≥ d·ªØ li·ªáu</p>'; }
</script>
</body>
</html>
