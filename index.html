<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá Th·ªëng Qu·∫£n Tr·ªã Dubai PRO (Chung Anh)</title>
    <style>
        :root {
            --primary-color: #007bff; --secondary-color: #6c757d; --success-color: #28a745;
            --danger-color: #dc3545; --warning-color: #ffc107; --info-color: #17a2b8;
            --light-bg: #f4f6f8; --white: #ffffff; --border-color: #dee2e6;
        }
        body { font-family: 'Segoe UI', Roboto, sans-serif; margin: 0; padding: 0; background-color: var(--light-bg); color: #333; font-size: 14px; }
        
        /* HEADER & TABS */
        .header { background-color: var(--primary-color); color: var(--white); padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .header h1 { margin: 0; font-size: 20px; font-weight: 600; }
        .nav-tabs { display: flex; background-color: var(--white); padding: 0 20px; border-bottom: 1px solid var(--border-color); overflow-x: auto; }
        .nav-item { padding: 15px 20px; cursor: pointer; font-weight: 500; color: var(--secondary-color); border-bottom: 3px solid transparent; transition: all 0.3s; white-space: nowrap; }
        .nav-item:hover { color: var(--primary-color); background-color: #f8f9fa; }
        .nav-item.active { color: var(--primary-color); border-bottom: 3px solid var(--primary-color); background-color: #eef7ff; }
        .main-content { padding: 20px; max-width: 100%; margin: 0 auto; }
        .tab-pane { display: none; }
        .tab-pane.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* LAYOUTS */
        .card { background: var(--white); border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); padding: 15px; margin-bottom: 15px; border: 1px solid var(--border-color); }
        .sales-layout { display: grid; grid-template-columns: 35% 63%; gap: 2%; }
        .expense-layout { display: grid; grid-template-columns: 40% 58%; gap: 2%; }
        .inventory-layout { display: grid; grid-template-columns: 40% 58%; gap: 2%; }
        .crm-layout { display: grid; grid-template-columns: 30% 68%; gap: 2%; height: calc(100vh - 140px); }
        
        /* CRM STYLES */
        .crm-sidebar { overflow-y: auto; border-right: 1px solid #eee; padding-right: 10px; }
        .crm-detail { overflow-y: auto; padding-left: 20px; }
        .cust-item { padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; transition: 0.2s; border-radius: 4px; margin-bottom: 5px; background: #fff;}
        .cust-item:hover { background-color: #f8f9fa; }
        .cust-item.active { background-color: #eef7ff; border-left: 4px solid var(--primary-color); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .cust-name { font-weight: bold; font-size: 15px; margin-bottom: 3px;}
        .cust-phone { font-size: 13px; color: #666; display: flex; align-items: center; gap: 5px;}
        
        /* CRM INLINE EDIT INPUTS */
        .crm-input { 
            width: 100%; 
            padding: 5px; 
            border: 1px solid transparent; 
            background: transparent; 
            font-family: inherit; 
            color: inherit; 
            transition: all 0.3s;
            border-radius: 4px;
        }
        .crm-input:disabled { background: transparent; color: #333; cursor: default; }
        .crm-input.editing { border: 1px solid #007bff; background: #fff; }
        .crm-input-name { font-size: 24px; font-weight: bold; margin-bottom: 5px; }
        .crm-input-info { font-size: 14px; color: #666; margin-bottom: 2px; }

        /* CRM INFO BOX */
        .crm-info-box { display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }
        .crm-stat-card { flex: 1; min-width: 120px; background: #fff; padding: 15px; border-radius: 8px; border: 1px solid #eee; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .crm-stat-card h4 { margin: 0 0 5px 0; font-size: 13px; color: #777; font-weight: normal; text-transform: uppercase; }
        .crm-stat-card div { font-size: 20px; font-weight: bold; color: var(--primary-color); }
        .crm-stat-card.orange div { color: #fd7e14; }
        .crm-stat-card.green div { color: #28a745; }

        /* CHART STYLES */
        .chart-container { display: flex; align-items: flex-end; justify-content: space-around; height: 250px; padding-top: 30px; border-bottom: 1px solid #ccc; gap: 15px; }
        .chart-column { flex: 1; display: flex; flex-direction: column; justify-content: flex-end; align-items: center; position: relative; max-width: 80px; }
        .chart-bar { width: 100%; border-radius: 4px 4px 0 0; transition: height 0.8s ease; min-height: 2px; position: relative; cursor: pointer; }
        .chart-bar:hover { opacity: 0.85; }
        .chart-value { position: absolute; top: -25px; left: 50%; transform: translateX(-50%); font-size: 11px; font-weight: bold; color: #333; white-space: nowrap; }
        .chart-label { margin-top: 8px; font-size: 11px; text-align: center; color: #555; word-wrap: break-word; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; line-height: 1.2; height: 28px; }

        /* FORM & BUTTONS */
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; }
        .form-control { width: 100%; padding: 8px 10px; border: 1px solid #ced4da; border-radius: 4px; font-size: 13px; box-sizing: border-box; }
        .form-control:focus { border-color: var(--primary-color); outline: none; }
        .btn { padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; font-weight: 500; font-size: 13px; display: inline-flex; align-items: center; gap: 5px; }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-success { background-color: var(--success-color); color: white; }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-secondary { background-color: var(--secondary-color); color: white; }
        .btn-warning { background-color: var(--warning-color); color: #333; }
        .btn-info { background-color: var(--info-color); color: white; }
        .btn-sm { padding: 4px 8px; font-size: 11px; }

        /* TABLES */
        table { width: 100%; border-collapse: collapse; margin-top: 5px; font-size: 13px; }
        th { background-color: #f1f3f5; padding: 10px; text-align: left; border-bottom: 2px solid var(--border-color); cursor: pointer; user-select: none;}
        th:hover { background-color: #e2e6ea; }
        td { padding: 10px; border-bottom: 1px solid var(--border-color); }
        .text-right { text-align: right; }
        .text-center { text-align: center; }

        /* INVOICE PREVIEW */
        .invoice-box { background: #fff; padding: 30px; border: 1px solid #ccc; font-family: 'Times New Roman', Times, serif; font-size: 14px; line-height: 1.4; color: #000; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        .inv-title { text-align: center; text-transform: uppercase; font-weight: bold; font-size: 22px; margin-bottom: 5px; }
        .inv-sub-title { text-align: center; font-style: italic; margin-bottom: 20px; font-size: 13px; }
        .inv-table { width: 100%; border-collapse: collapse; margin: 15px 0; }
        .inv-table th { background-color: #4472c4; color: white; text-align: center; border: 1px solid #ccc; padding: 5px; -webkit-print-color-adjust: exact; }
        .inv-table td { border: 1px solid #ccc; padding: 5px; }
        .inv-info-grid { display: flex; justify-content: space-between; margin-bottom: 10px; }
        .inv-total-section { margin-top: 10px; display: flex; justify-content: flex-end; }
        .inv-total-table { width: 50%; }
        .inv-footer-grid { display: flex; justify-content: space-between; margin-top: 30px; text-align: center; }

        /* DASHBOARD */
        .dashboard-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px; }
        .kpi-card { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-left: 4px solid #ccc; }
        .kpi-card h3 { margin: 0 0 10px 0; font-size: 14px; color: #666; text-transform: uppercase; }
        .kpi-card .value { font-size: 24px; font-weight: bold; color: #333; }
        .kpi-card.revenue { border-color: var(--primary-color); }
        .kpi-card.cost { border-color: var(--warning-color); }
        .kpi-card.expense { border-color: var(--danger-color); }
        .kpi-card.profit { border-color: var(--success-color); }
        
        .progress-bar-container { width: 100%; background-color: #e9ecef; border-radius: 4px; height: 10px; margin-top: 5px; }
        .progress-bar { height: 100%; border-radius: 4px; text-align: center; color: white; font-size: 11px; line-height: 20px; transition: width 0.5s; }
        .filter-bar { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; align-items: center;}
        
        .custom-filter-container { display: none; background: #fff; padding: 5px 10px; border-radius: 4px; border: 1px solid #ccc; gap: 10px; align-items: center; margin-left: 10px; }
        .custom-filter-container.active { display: flex; }

        #editModeBanner { background: #ffc107; color: #333; padding: 10px; text-align: center; font-weight: bold; margin-bottom: 15px; display: none; border-radius: 4px; }
        
        /* Modal */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888; width: 800px; max-width: 90%; border-radius: 8px; position: relative; }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        
        .editable-input { width: 100%; padding: 4px; border: 1px solid #89c2ff; border-radius: 3px; font-family: inherit; }
    </style>
</head>
<body>

<div class="header">
    <div style="display: flex; align-items: center; gap: 10px;">
        <span style="font-size: 24px;">üè¢</span>
        <h1>H·ªá Th·ªëng Qu·∫£n Tr·ªã Dubai PRO (Dubai 1-7-2020 Si√™u Vip Pro)</h1>
    </div>
    <div>
        <button class="btn btn-secondary btn-sm" onclick="exportData()">üíæ Sao L∆∞u</button>
        <button class="btn btn-warning btn-sm" onclick="document.getElementById('fileInput').click()">üìÇ Ph·ª•c H·ªìi</button>
        <input type="file" id="fileInput" accept=".json" style="display:none;">
    </div>
</div>

<div class="nav-tabs">
    <div class="nav-item active" onclick="switchTab('tab-sales')">üõí B√°n H√†ng</div>
    <div class="nav-item" onclick="switchTab('tab-cashflow')">üí∏ Thu Chi</div>
    <div class="nav-item" onclick="switchTab('tab-customers')">üë• Kh√°ch H√†ng</div>
    <div class="nav-item" onclick="switchTab('tab-staff')">üßë‚Äçüíº Nh√¢n S·ª±</div>
    <div class="nav-item" onclick="switchTab('tab-inventory')">üì¶ Kho H√†ng</div>
    <div class="nav-item" onclick="switchTab('tab-reports')">üìä B√°o C√°o</div>
</div>

<div class="main-content">

    <div id="tab-sales" class="tab-pane active">
        <div id="editModeBanner">‚ö†Ô∏è ƒêANG S·ª¨A ƒê∆†N H√ÄNG: <span id="editingOrderIDText"></span></div>
        <div class="sales-layout">
            <div>
                <div class="card" id="salesCardInfo">
                    <h5 style="margin:0 0 10px 0; color:var(--primary-color);">1. Th√¥ng tin Chung</h5>
                    <div style="margin-bottom: 10px;">
                        <label style="font-size:12px; font-weight:bold;">Ng√†y ƒë∆°n h√†ng:</label>
                        <input type="date" id="orderDate" class="form-control" onchange="updateInvoicePreview()">
                    </div>
                    
                    <div style="margin-bottom: 10px;"><select id="saleStaffSelect" class="form-control" onchange="updateInvoicePreview()"><option value="">-- Ch·ªçn sales --</option></select></div>
                    <div style="display: grid; gap: 10px;">
                        <input type="text" id="custPhone" class="form-control" placeholder="SƒêT Kh√°ch (*)" onblur="findCustomerByPhone()" oninput="updateInvoicePreview()">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px;">
                            <input type="text" id="custName" class="form-control" placeholder="T√™n kh√°ch" oninput="updateInvoicePreview()">
                            <input type="text" id="custAddress" class="form-control" placeholder="ƒê·ªãa ch·ªâ" oninput="updateInvoicePreview()">
                        </div>
                    </div>
                </div>
                <div class="card">
                    <h5 style="margin:0 0 10px 0; color:var(--primary-color);">2. Ch·ªçn H√†ng (G√µ t√¨m ki·∫øm)</h5>
                    <datalist id="productListSales"></datalist>
                    <table id="orderItemsTable" style="margin-top:0;"><thead><tr><th style="width: 45%">T√™n H√†ng (k√®m gi√° v·ªën)</th><th style="width: 15%">SL</th><th style="width: 25%">ƒê∆°n gi√°</th><th style="width: 15%"></th></tr></thead><tbody id="orderItemsBody"></tbody></table>
                    <button class="btn btn-secondary btn-sm" style="width:100%; margin-top:5px;" onclick="createOrderItemRow()">‚ûï Th√™m d√≤ng</button>
                </div>
                <div class="card">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                         <div><label style="font-size:12px;">Ph√≠ Ship/Kh√°c (+/-)</label><input type="number" id="shippingCost" class="form-control" value="0" oninput="updateInvoicePreview()"></div>
                         <div><label style="font-size:12px;">Ghi ch√∫ (In phi·∫øu)</label><input type="text" id="orderNote" class="form-control" placeholder="..." oninput="updateInvoicePreview()"></div>
                    </div>
                    <div style="margin-top: 10px;">
                        <label style="font-size:12px; color: var(--danger-color); font-weight: bold;">üìù Ghi ch√∫ n·ªôi b·ªô (Sales):</label>
                        <input type="text" id="internalNote" class="form-control" style="border: 1px dashed var(--danger-color); background: #fff5f5;" placeholder="Th√¥ng tin n√†y ch·ªâ hi·ªÉn th·ªã n·ªôi b·ªô...">
                    </div>
                    
                    <div style="margin-top: 15px; display: flex; gap: 10px;">
                        <button id="btnSaveOrder" class="btn btn-primary" style="flex: 1; padding: 10px;" onclick="submitOrder()">‚úÖ L∆ØU ƒê∆†N</button>
                        <button id="btnCancelEdit" class="btn btn-secondary" style="display:none; padding: 10px;" onclick="cancelEditOrder()">‚ùå H·ª¶Y</button>
                    </div>
                </div>
            </div>
            <div>
                <div class="card" style="background: #ccc; padding: 20px; height: calc(100vh - 150px); overflow-y: auto;">
                    <div id="invoicePreview" class="invoice-box">
                        <div class="inv-title">PHI·∫æU XU·∫§T KHO B√ÅN H√ÄNG</div>
                        <div class="inv-sub-title">Ng√†y: <span id="invDate">...</span><br>NV: <span id="invStaff" style="font-weight:bold">...</span> - SƒêT: <span id="invStaffPhone">...</span></div>
                        <div class="inv-info-grid"><div class="inv-info-left"><div>Kh√°ch: <span id="invCustName" style="font-weight:bold">...</span></div><div>SƒêT: <span id="invCustPhone">...</span></div><div>ƒêC: <span id="invCustAddr">...</span></div></div><div class="inv-info-right"><div style="font-weight:bold">S·ªê: <span id="invID">...</span></div></div></div>
                        <table class="inv-table"><thead><tr><th>STT</th><th>T√äN H√ÄNG</th><th>ƒêVT</th><th>SL</th><th>ƒê∆†N GI√Å</th><th>TH√ÄNH TI·ªÄN</th></tr></thead><tbody id="invItemsList"></tbody></table>
                        <div class="inv-total-section"><table class="inv-total-table"><tr><td>C·ªông ti·ªÅn h√†ng:</td><td><span id="invSubTotal">0</span></td></tr><tr><td>Ph√≠ Ship/Kh√°c:</td><td><span id="invShip">0</span></td></tr><tr><td class="inv-total-label" style="color:#dc3545">T·ªïng thanh to√°n:</td><td class="inv-total-value"><span id="invTotal">0</span></td></tr></table></div>
                        <div style="margin-top:10px;font-style:italic">B·∫±ng ch·ªØ: <span id="invTotalText">...</span></div>
                        <div style="margin-top:10px; border-top:1px dotted #999; padding-top:5px; font-size: 13px;">Ghi ch√∫: <span id="invNoteText">...</span></div>
                        <div class="inv-footer-grid"><div><strong>Ng∆∞·ªùi mua</strong><br><em>(K√Ω t√™n)</em></div><div><strong>K·∫ø to√°n</strong><br><em>(K√Ω t√™n)</em></div><div><strong>Gi√°m ƒë·ªëc</strong><br><em>(K√Ω t√™n)</em></div></div>
                    </div>
                    <div style="text-align: center; margin-top: 15px;"><button class="btn btn-secondary" onclick="printInvoice()">üñ®Ô∏è In Phi·∫øu</button></div>
                </div>
            </div>
        </div>
    </div>

    <div id="tab-cashflow" class="tab-pane">
        <div class="expense-layout">
            <div class="card"><h3 style="color: var(--primary-color);">üìù L·∫≠p Phi·∫øu Thu / Chi</h3>
            <form id="cashflowForm" class="form-grid" style="grid-template-columns: 1fr;">
                <div style="display:flex; gap:10px;">
                    <div style="flex:1"><label>Lo·∫°i phi·∫øu:</label><select id="cfType" class="form-control" style="font-weight:bold;"><option value="THU" style="color:green">‚ûï PHI·∫æU THU</option><option value="CHI" style="color:red">‚ûñ PHI·∫æU CHI</option></select></div>
                    <div style="flex:1"><label>Ng√†y:</label><input type="date" id="cfDate" class="form-control" required></div>
                </div>
                <div><label>S·ªë ti·ªÅn (VND):</label><input type="number" id="cfAmount" class="form-control" required min="0"></div>
                <div>
                    <label>ƒê∆°n h√†ng li√™n quan (M√£ PXK - T√πy ch·ªçn):</label>
                    <input type="text" id="cfOrderId" class="form-control" list="orderListSuggestions" placeholder="G√µ m√£ ƒë∆°n ho·∫∑c ch·ªçn...">
                    <datalist id="orderListSuggestions"></datalist>
                </div>
                <div><label>H·∫°ng m·ª•c:</label><input type="text" id="cfCategory" class="form-control" list="catList" placeholder="VD: Ti·ªÅn ƒëi·ªán, Ship, B√°n ph·∫ø li·ªáu..."><datalist id="catList"><option value="Ti·ªÅn ƒëi·ªán/n∆∞·ªõc"><option value="L∆∞∆°ng nh√¢n vi√™n"><option value="Thu√™ m·∫∑t b·∫±ng"><option value="Ph√≠ Ship"><option value="Thu kh√°c"></datalist></div>
                <div><label>Ghi ch√∫:</label><input type="text" id="cfNote" class="form-control"></div>
                <button type="submit" class="btn btn-primary">üíæ L∆∞u Phi·∫øu</button>
            </form>
            </div>
            <div class="card"><h3>üìú L·ªãch S·ª≠ Thu Chi</h3><div style="max-height: 400px; overflow-y: auto;"><table id="cashflowTable"><thead><tr><th>Ng√†y</th><th>Lo·∫°i</th><th>S·ªë ti·ªÅn</th><th>ƒê∆°n h√†ng</th><th>M·ª•c</th><th>X√≥a</th></tr></thead><tbody></tbody></table></div></div>
        </div>
    </div>

    <div id="tab-customers" class="tab-pane">
        <div class="card" style="height: 100%; overflow: hidden;">
            <div class="crm-layout">
                <div class="crm-sidebar">
                    <div style="position: sticky; top: 0; background: white; padding-bottom: 10px; border-bottom: 1px solid #eee; margin-bottom: 10px;">
                        <input type="text" id="crmSearch" class="form-control" placeholder="üîç T√¨m SƒêT ho·∫∑c T√™n..." oninput="renderCrmSidebar()">
                    </div>
                    <div id="crmCustomerList"></div>
                </div>
                <div class="crm-detail" id="crmDetailView">
                    <div style="text-align: center; color: #888; margin-top: 100px;">
                        <span style="font-size: 50px;">üë•</span>
                        <h3>Ch·ªçn m·ªôt kh√°ch h√†ng t·ª´ danh s√°ch b√™n tr√°i</h3>
                        <p>Th√¥ng tin chi ti·∫øt v√† l·ªãch s·ª≠ ƒë∆°n h√†ng s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="tab-staff" class="tab-pane">
        <div class="card"><h3>Th√™m Nh√¢n Vi√™n</h3><form id="addStaffForm" class="form-grid"><input type="text" id="staffName" class="form-control" required placeholder="T√™n"><input type="text" id="staffPhone" class="form-control" placeholder="SƒêT"><input type="text" id="staffAddress" class="form-control" placeholder="ƒêC"><input type="text" id="staffNote" class="form-control" placeholder="Note"><button class="btn btn-success">‚ûï Th√™m</button></form></div>
        <div class="card"><h3>Danh S√°ch Sales</h3><table id="staffTable"><thead><tr><th>T√™n</th><th>SƒêT</th><th>ƒêC</th><th>Note</th><th>X√≥a</th></tr></thead><tbody></tbody></table></div>
    </div>

    <div id="tab-inventory" class="tab-pane">
        <div class="inventory-layout">
            <div class="card">
                <h3 style="color: var(--info-color);">üè≠ Nh√† Cung C·∫•p</h3>
                <input type="text" id="searchSupplier" class="form-control" placeholder="üîç T√¨m NCC..." style="margin-bottom: 10px;" oninput="renderSuppliers()">
                <form id="addSupplierForm" class="form-grid" style="margin-bottom: 15px;"><input type="text" id="suppName" class="form-control" required placeholder="T√™n NCC"><input type="text" id="suppPhone" class="form-control" placeholder="SƒêT"><input type="text" id="suppAddr" class="form-control" placeholder="ƒêC"><button type="submit" class="btn btn-info">‚ûï Th√™m NCC</button></form>
                <div style="max-height: 200px; overflow-y: auto; border: 1px solid #eee;">
                    <table id="supplierTable" style="margin-top:0;"><thead><tr><th>T√™n NCC</th><th>SƒêT</th><th>ƒê·ªãa ch·ªâ</th><th>X√≥a</th></tr></thead><tbody></tbody></table>
                </div>
            </div>
            <div class="card">
                <h3>üì¶ Nh·∫≠p H√†ng M·ªõi</h3>
                <div style="margin-bottom: 10px; display: flex; gap: 10px; align-items: flex-end;">
                    <div style="flex:1;">
                        <label>Nh√† Cung C·∫•p:</label>
                        <select id="stockSupplier" class="form-control"><option value="">-- Ch·ªçn NCC --</option></select>
                    </div>
                    <div style="flex:1;">
                        <label>Ng√†y nh·∫≠p:</label>
                        <input type="date" id="importDate" class="form-control">
                    </div>
                </div>
                
                <datalist id="productListStock"></datalist>
                <table id="stockEntryTable" style="margin-bottom: 15px;"><thead><tr><th style="width: 35%">T√™n SP (G·ª£i √Ω)</th><th style="width: 15%">SL</th><th style="width: 25%">Gi√° v·ªën</th><th style="width: 15%">Ghi ch√∫</th><th style="width: 10%"></th></tr></thead><tbody id="stockEntryBody"></tbody></table>
                <div style="display: flex; justify-content: space-between;">
                    <button class="btn btn-secondary btn-sm" onclick="createStockRow()">‚ûï Th√™m d√≤ng</button>
                    <div>
                         <button class="btn btn-warning" onclick="syncWithGoogleSheets()">‚òÅÔ∏è ƒê·ªìng b·ªô t·ª´ Sheet</button>
                         <button class="btn btn-success" onclick="submitStockEntry()">‚úÖ NH·∫¨P KHO</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3>üìä Danh S√°ch T·ªìn Kho</h3>
                <div>
                    <select id="filterSupplier" class="form-control" style="display:inline-block; width:150px;" onchange="renderInventory()">
                        <option value="">T·∫•t c·∫£ NCC</option>
                    </select>
                    <button class="btn btn-secondary btn-sm" onclick="sortInventory('stock')">üîΩ T·ªìn nhi·ªÅu</button>
                    <button class="btn btn-secondary btn-sm" onclick="sortInventory('sold')">üîΩ B√°n ch·∫°y</button>
                </div>
            </div>
            <table id="inventoryTable"><thead><tr><th>T√™n SP</th><th>Nh·∫≠p</th><th>B√°n</th><th>T·ªìn</th><th>Gi√° V·ªën</th><th>Ghi ch√∫</th><th>H√†nh ƒë·ªông</th></tr></thead><tbody></tbody></table>
        </div>
    </div>

    <div id="tab-reports" class="tab-pane">
        <div class="filter-bar">
            <button id="btn-today" class="btn btn-secondary" onclick="filterReports('today')">H√¥m nay</button>
            <button id="btn-week" class="btn btn-secondary" onclick="filterReports('week')">Tu·∫ßn n√†y</button>
            <button id="btn-month" class="btn btn-secondary" onclick="filterReports('month')">Th√°ng n√†y</button>
            <button id="btn-year" class="btn btn-secondary" onclick="filterReports('year')">NƒÉm nay</button>
            <button id="btn-all" class="btn btn-secondary" onclick="filterReports('all')">T·∫•t c·∫£</button>
            
            <button id="btn-custom" class="btn btn-secondary" onclick="toggleCustomFilter()">üìÖ T√πy ch·ªçn</button>
            
            <div id="customFilterArea" class="custom-filter-container">
                <span style="font-weight:bold;">T·ª´:</span>
                <input type="date" id="filterStart" class="form-control" style="width: auto;">
                <span style="font-weight:bold;">ƒê·∫øn:</span>
                <input type="date" id="filterEnd" class="form-control" style="width: auto;">
                <button class="btn btn-primary btn-sm" onclick="filterReports('custom')">üîç L·ªçc d·ªØ li·ªáu</button>
            </div>
        </div>

        <div class="dashboard-grid"><div class="kpi-card revenue"><h3>DOANH THU (ƒê∆°n h√†ng)</h3><div class="value" id="kpiRevenue">0 ‚Ç´</div></div><div class="kpi-card cost"><h3>T·ªîNG V·ªêN NH·∫¨P (Kho)</h3><div class="value" id="kpiTotalImport">0 ‚Ç´</div></div><div class="kpi-card expense"><h3>T·ªîNG CHI (V·∫≠n h√†nh)</h3><div class="value" id="kpiTotalExpense">0 ‚Ç´</div></div><div class="kpi-card profit"><h3>L·ª¢I NHU·∫¨N R√íNG</h3><div class="value" id="kpiNetProfit">0 ‚Ç´</div></div></div>
        
        <div class="sales-layout" style="margin-bottom: 20px;">
            <div class="card">
                <h4 style="border-bottom: 2px solid var(--primary-color); padding-bottom: 5px; color: var(--primary-color);">üèÜ Top Sales (Doanh s·ªë)</h4>
                <div id="chartTopSales"></div>
            </div>
            <div class="card">
                <h4 style="border-bottom: 2px solid var(--success-color); padding-bottom: 5px; color: var(--success-color);">üíé Top Kh√°ch H√†ng</h4>
                <div id="chartTopCustomers"></div>
            </div>
        </div>

        <div class="sales-layout">
            <div class="card">
                <h4>üìä B·∫£ng C√¢n ƒê·ªëi T√†i Ch√≠nh</h4>
                <div style="margin-bottom:10px;"><span>T·ª∑ su·∫•t LN: <strong id="profitMargin">0%</strong></span><div class="progress-bar-container"><div id="barProfit" class="progress-bar" style="width:0%; background-color:var(--success-color);"></div></div></div>
                <table class="table">
                    <tr><td>(+) Doanh Thu B√°n H√†ng:</td><td class="text-right" id="rptRev">0</td></tr>
                    <tr><td>(-) Gi√° V·ªën H√†ng B√°n:</td><td class="text-right" id="rptCOGS">0</td></tr>
                    <tr><td>(-) T·ªïng Chi Ph√≠ ƒê∆°n H√†ng (Ship, Kh√°c...):</td><td class="text-right" id="rptOrderCost">0</td></tr>
                    <tr><td style="font-weight:bold;">= L·ª£i Nhu·∫≠n (G·ªôp):</td><td class="text-right" style="font-weight:bold;" id="rptGrossProfit">0</td></tr>
                    <tr><td>(-) T·ªïng Chi Ph√≠ V·∫≠n H√†nh (Ngo√†i ƒë∆°n):</td><td class="text-right" id="rptOpExp" style="color:red">0</td></tr>
                    <tr><td>(+) Thu Kh√°c (Ngo√†i b√°n h√†ng):</td><td class="text-right" id="rptOtherInc" style="color:green">0</td></tr>
                    <tr style="background:#eef7ff;"><td style="font-weight:bold;color:green;font-size:16px;">= L·ª£i Nhu·∫≠n R√≤ng:</td><td class="text-right" style="font-weight:bold;color:green;font-size:16px;" id="rptNetProfit">0</td></tr>
                </table>
            </div>
            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center;"><h4>üìú L·ªãch S·ª≠ ƒê∆°n H√†ng</h4><input type="text" id="searchOrderReport" class="form-control" style="width:150px;" placeholder="T√¨m M√£ ƒêH..." oninput="searchOrderTable()"></div>
                <div style="max-height: 400px; overflow-y:auto;"><table id="rptOrdersTable"><thead><tr><th>Kh√°ch h√†ng</th><th>M√£</th><th>Ng√†y</th><th>Ghi ch√∫ n·ªôi b·ªô</th><th>Doanh thu</th><th>L√£i th·ª±c</th><th>Thao t√°c</th></tr></thead><tbody></tbody></table></div>
            </div>
        </div>
        <div class="card">
            <h4>üí∏ Chi Ti·∫øt Chi Ph√≠</h4>
            <div style="display:flex;gap:20px;">
                <div style="flex:1;"><h5>Chi ph√≠ ƒê∆°n h√†ng (Phi·∫øu chi c√≥ M√£ PXK)</h5><table id="rptOrderExpTable"><thead><tr><th>Ng√†y</th><th>M√£ ƒêH</th><th>S·ªë ti·ªÅn</th><th>L√Ω do</th></tr></thead><tbody></tbody></table></div>
                <div style="flex:1;"><h5>Chi ph√≠ V·∫≠n h√†nh (Phi·∫øu chi KH√îNG m√£ PXK)</h5><table id="rptGenExpTable"><thead><tr><th>Ng√†y</th><th>Lo·∫°i</th><th>S·ªë ti·ªÅn</th></tr></thead><tbody></tbody></table></div>
            </div>
        </div>
    </div>

</div>

<div id="invoiceModal" class="modal"><div class="modal-content"><span class="close" onclick="document.getElementById('invoiceModal').style.display='none'">&times;</span><div id="modalInvoiceContent"></div><div style="text-align: center; margin-top: 20px;"><button class="btn btn-secondary" onclick="printModalInvoice()">üñ®Ô∏è In Phi·∫øu</button></div></div></div>

<script>
    // --- C·∫§U H√åNH KH√ìA D·ªÆ LI·ªÜU ---
    const KEYS = { STOCK: 'inventory_stock', ORDERS: 'daily_orders', CUSTOMERS: 'customer_list', STAFF: 'sales_staff', SUPPLIERS: 'suppliers_list', CASHFLOW: 'cashflow_data' };
    
    // --- C·∫§U H√åNH GOOGLE SHEETS (Thay URL c·ªßa b·∫°n v√†o ƒë√¢y) ---
    const GOOGLE_SCRIPT_URL = 'THAY_LINK_WEB_APP_CUA_BAN_VAO_DAY'; 

    // --- H√ÄM TI·ªÜN √çCH ---
    const loadData = (key) => { try { return JSON.parse(localStorage.getItem(key)) || []; } catch { return []; } };
    const saveData = (key, data) => localStorage.setItem(key, JSON.stringify(data));
    const formatCurrency = (n, short=false) => { 
        if(short && n >= 1000000) return (n/1000000).toFixed(1) + 'M';
        if(short && n >= 1000) return (n/1000).toFixed(1) + 'k';
        return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(n || 0);
    };
    // H√†m chu·∫©n h√≥a chu·ªói ƒë·ªÉ so s√°nh kh√¥ng ph√¢n bi·ªát hoa th∆∞·ªùng
    const normalizeStr = (str) => String(str).trim().toLowerCase();
    
    // --- T·∫†O ID M·ªöI: PXK + Th√°ng + NƒÉm (2 s·ªë) + Ch·ªØ + 9 S·ªë ---
    const generateID = () => {
        const now = new Date();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const year = String(now.getFullYear()).slice(-2); // L·∫•y 2 s·ªë cu·ªëi nƒÉm
        const alphabet = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
        const randomChar = alphabet[Math.floor(Math.random() * alphabet.length)];
        const randomNum = Math.floor(Math.random() * 1000000000).toString().padStart(9, '0'); // 9 s·ªë
        return `PXK${month}${year}${randomChar}${randomNum}`;
    };
    
    let editingOrderId = null;
    let currentReportPeriod = 'today';

    // --- KH·ªûI T·∫†O ---
    document.addEventListener('DOMContentLoaded', () => { 
        switchTab('tab-sales'); 
        const today = new Date().toISOString().slice(0, 10);
        ['cfDate', 'orderDate', 'importDate', 'filterStart', 'filterEnd'].forEach(id => {
            const el = document.getElementById(id); if(el) el.value = today;
        });
        document.getElementById('fileInput')?.addEventListener('change', handleFileImport);
        document.getElementById('cashflowForm')?.addEventListener('submit', handleCashflowSubmit);
        document.getElementById('addStaffForm')?.addEventListener('submit', handleAddStaff);
        document.getElementById('addSupplierForm')?.addEventListener('submit', handleAddSupplier);
    });

    const switchTab = (tabId) => {
        const tabEl = document.getElementById(tabId); if(!tabEl) return; 
        document.querySelectorAll('.tab-pane').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        tabEl.classList.add('active');
        const map = {'tab-sales':0, 'tab-cashflow':1, 'tab-customers':2, 'tab-staff':3, 'tab-inventory':4, 'tab-reports':5};
        if(map[tabId] !== undefined) document.querySelectorAll('.nav-item')[map[tabId]].classList.add('active');
        
        if(tabId === 'tab-sales') { populateStaffSelect(); updateProductDatalist('productListSales'); if(!editingOrderId) createOrderItemRow(); updateInvoicePreview(); }
        if(tabId === 'tab-cashflow') { renderCashflow(); updateOrderDatalist(); }
        if(tabId === 'tab-customers') renderCrmSidebar();
        if(tabId === 'tab-staff') renderStaff();
        if(tabId === 'tab-inventory') { renderSuppliers(); populateSupplierSelect(); renderInventory(); updateProductDatalist('productListStock'); createStockRow(); }
        if(tabId === 'tab-reports') filterReports(currentReportPeriod || 'today'); 
    };

    // --- GOOGLE SHEETS SYNC ---
    const syncWithGoogleSheets = async () => {
        if(GOOGLE_SCRIPT_URL.includes('THAY_LINK')) { alert('B·∫°n ch∆∞a c·∫•u h√¨nh link Google Apps Script!'); return; }
        if(!confirm('Nh·∫≠p th√™m h√†ng t·ª´ Google Sheets?')) return;
        try {
            const btn = event.target; btn.textContent = "‚è≥..."; btn.disabled = true;
            const response = await fetch(GOOGLE_SCRIPT_URL);
            const data = await response.json();
            let stock = loadData(KEYS.STOCK); let count = 0;
            data.forEach(item => {
                if(item.name && item.qty > 0) {
                    let exist = stock.find(s => normalizeStr(s.name) === normalizeStr(item.name) && parseFloat(s.costPrice) === parseFloat(item.cost));
                    if(exist) { exist.quantityIn += parseInt(item.qty); } 
                    else { stock.push({ name: item.name, quantityIn: parseInt(item.qty), quantityOut: 0, costPrice: parseFloat(item.cost), supplier: item.supplier || '', note: 'Nh·∫≠p t·ª´ Sheets' }); }
                    count++;
                }
            });
            saveData(KEYS.STOCK, stock); renderInventory(); updateProductDatalist('productListStock');
            alert(`ƒê√£ ƒë·ªìng b·ªô ${count} d√≤ng!`); btn.textContent = "‚òÅÔ∏è ƒê·ªìng b·ªô t·ª´ Sheet"; btn.disabled = false;
        } catch (error) { console.error(error); alert('L·ªói k·∫øt n·ªëi!'); event.target.textContent = "‚òÅÔ∏è ƒê·ªìng b·ªô t·ª´ Sheet"; event.target.disabled = false; }
    };

    // --- LOGIC CRM (INLINE EDIT) ---
    const renderCrmSidebar = () => {
        const listDiv = document.getElementById('crmCustomerList');
        const term = normalizeStr(document.getElementById('crmSearch').value);
        let customers = loadData(KEYS.CUSTOMERS);
        if (term) customers = customers.filter(c => c.phone.includes(term) || normalizeStr(c.name).includes(term));
        if(customers.length === 0) { listDiv.innerHTML = '<div style="padding:15px;text-align:center;color:#999">Ch∆∞a c√≥ kh√°ch h√†ng</div>'; return; }
        customers.reverse();
        listDiv.innerHTML = customers.map(c => `<div class="cust-item" onclick="viewCustomerDetail('${c.phone}')"><div class="cust-name">${c.name}</div><div class="cust-phone"><span style="color:#666">üì± ${c.phone}</span></div></div>`).join('');
    };

    const viewCustomerDetail = (phone) => {
        const customers = loadData(KEYS.CUSTOMERS); const customer = customers.find(c => String(c.phone).trim() === String(phone).trim()); if (!customer) return;
        document.querySelectorAll('.cust-item').forEach(el => el.classList.remove('active')); event.currentTarget.classList.add('active');
        const orders = loadData(KEYS.ORDERS).filter(o => String(o.customer.phone).trim() === String(phone).trim()).sort((a, b) => new Date(b.date) - new Date(a.date));
        const totalSpent = orders.reduce((sum, o) => sum + o.totalAmount, 0);
        
        // RENDER INLINE EDIT VIEW
        document.getElementById('crmDetailView').innerHTML = `
            <div class="card" style="border-top: 5px solid var(--primary-color);">
                <div style="display:flex; justify-content:space-between; align-items:flex-start">
                    <div style="flex:1; margin-right:20px;">
                        <input type="text" id="editCustName" class="crm-input crm-input-name" value="${customer.name}" disabled>
                        <div class="crm-input-info">
                            üìç <input type="text" id="editCustAddress" class="crm-input" style="width:80%; display:inline-block;" value="${customer.address||''}" disabled>
                        </div>
                        <div class="crm-input-info">
                            üìû <input type="text" id="editCustPhone" class="crm-input" style="width:auto; display:inline-block;" value="${customer.phone}" disabled>
                        </div>
                        <div style="margin-top:10px;">
                            <button id="btnEditCust" class="btn btn-secondary btn-sm" onclick="enableEditCustomer()">‚úèÔ∏è S·ª≠a</button>
                            <button id="btnSaveCust" class="btn btn-success btn-sm" style="display:none;" onclick="saveCustomerInfo('${customer.phone}')">üíæ L∆∞u</button>
                            <button id="btnCancelCust" class="btn btn-danger btn-sm" style="display:none;" onclick="viewCustomerDetail('${customer.phone}')">‚ùå H·ªßy</button>
                        </div>
                    </div>
                    <button class="btn btn-warning btn-sm" onclick="startOrderForCustomer('${customer.phone}', '${customer.name}', '${customer.address}')">üõí T·∫°o ƒë∆°n m·ªõi</button>
                </div>
                <hr style="margin:20px 0;"><div class="crm-info-box"><div class="crm-stat-card orange"><h4>T·ªïng Mua</h4><div>${formatCurrency(totalSpent)}</div></div><div class="crm-stat-card green"><h4>S·ªë ƒê∆°n</h4><div>${orders.length}</div></div></div>
            </div>
            <h4 style="color:var(--primary-color);">üìú L·ªãch s·ª≠ giao d·ªãch</h4>
            <div class="card"><table class="table"><thead><tr><th>M√£ ƒêH</th><th>Ng√†y</th><th>S·∫£n ph·∫©m</th><th>Ghi ch√∫ NB</th><th>Gi√° tr·ªã</th><th>S·ª≠a</th></tr></thead><tbody>
                ${orders.length > 0 ? orders.map(o => `<tr><td><b>${o.id}</b></td><td>${new Date(o.date).toLocaleDateString('vi-VN')}</td><td>${o.items.map(i=>`${i.name.split('{')[0]}(x${i.quantity})`).join(', ')}</td><td style="color:red;font-style:italic">${o.internalNote||''}</td><td class="text-right">${formatCurrency(o.totalAmount)}</td><td class="text-center"><button class="btn btn-secondary btn-sm" onclick="startEditOrder('${o.id}')">‚úèÔ∏è</button></td></tr>`).join('') : '<tr><td colspan="6" class="text-center">Ch∆∞a c√≥ ƒë∆°n h√†ng.</td></tr>'}
            </tbody></table></div>`;
    };
    
    // H√ÄM B·∫¨T CH·∫æ ƒê·ªò S·ª¨A
    const enableEditCustomer = () => {
        document.getElementById('editCustName').disabled = false;
        document.getElementById('editCustPhone').disabled = false;
        document.getElementById('editCustAddress').disabled = false;
        
        document.querySelectorAll('.crm-input').forEach(el => el.classList.add('editing'));
        
        document.getElementById('btnEditCust').style.display = 'none';
        document.getElementById('btnSaveCust').style.display = 'inline-block';
        document.getElementById('btnCancelCust').style.display = 'inline-block';
    };

    // H√ÄM L∆ØU TH√îNG TIN (Quan tr·ªçng: X·ª≠ l√Ω ƒë·ªïi SƒêT)
    const saveCustomerInfo = (oldPhone) => {
        const newName = document.getElementById('editCustName').value.trim();
        const newPhone = document.getElementById('editCustPhone').value.trim();
        const newAddr = document.getElementById('editCustAddress').value.trim();

        if(!newName || !newPhone) { alert('T√™n v√† SƒêT kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng!'); return; }

        let customers = loadData(KEYS.CUSTOMERS);
        let orders = loadData(KEYS.ORDERS);

        // Ki·ªÉm tra tr√πng SƒêT n·∫øu thay ƒë·ªïi
        if(newPhone !== oldPhone) {
            if(customers.find(c => c.phone === newPhone)) {
                alert('S·ªë ƒëi·ªán tho·∫°i m·ªõi ƒë√£ t·ªìn t·∫°i cho kh√°ch h√†ng kh√°c!');
                return;
            }
        }

        // C·∫≠p nh·∫≠t Database Kh√°ch h√†ng
        const cIndex = customers.findIndex(c => c.phone === oldPhone);
        if(cIndex !== -1) {
            customers[cIndex] = { ...customers[cIndex], name: newName, phone: newPhone, address: newAddr };
        }

        // C·∫≠p nh·∫≠t Database ƒê∆°n h√†ng (ƒê·ªìng b·ªô SƒêT m·ªõi v√†o l·ªãch s·ª≠ ƒë∆°n c≈©)
        orders.forEach(o => {
            if(o.customer.phone === oldPhone) {
                o.customer.name = newName;
                o.customer.phone = newPhone;
                o.customer.address = newAddr;
            }
        });

        saveData(KEYS.CUSTOMERS, customers);
        saveData(KEYS.ORDERS, orders);

        alert('C·∫≠p nh·∫≠t th√¥ng tin th√†nh c√¥ng!');
        renderCrmSidebar();
        viewCustomerDetail(newPhone); // Load l·∫°i v·ªõi SƒêT m·ªõi
    };
    
    const startOrderForCustomer = (phone, name, addr) => { switchTab('tab-sales'); document.getElementById('custPhone').value = phone; document.getElementById('custName').value = name; document.getElementById('custAddress').value = addr || ''; updateInvoicePreview(); };

    // --- LOGIC B√ÅN H√ÄNG (FIXED COGS) ---
    const submitOrder = () => {
        const rows = document.querySelectorAll('#orderItemsBody tr');
        let items = [], totalCost = 0, totalRev = 0; let stockData = loadData(KEYS.STOCK);
        
        for(let row of rows) { 
            const inputName = row.querySelector('.item-name').value; 
            const qty = parseFloat(row.querySelector('.item-qty').value); 
            const price = parseFloat(row.querySelector('.item-price').value); 
            if(!inputName || qty <= 0) { alert('Ki·ªÉm tra t√™n SP ho·∫∑c S·ªë l∆∞·ª£ng!'); return; } 
            
            // T√¨m s·∫£n ph·∫©m trong kho (Case Insensitive)
            // T√°ch t√™n hi·ªÉn th·ªã trong datalist ƒë·ªÉ l·∫•y t√™n g·ªëc so s√°nh
            const rawNameOnly = inputName.split(' {V:')[0];
            const prod = stockData.find(s => normalizeStr(s.name) === normalizeStr(rawNameOnly));
            
            let currentCost = 0;
            if(prod) { 
                currentCost = prod.costPrice;
                totalCost += (qty * currentCost); 
            } else {
                // N·∫øu kh√¥ng t√¨m th·∫•y trong kho (b√°n √¢m), t·∫°m t√≠nh gi√° v·ªën = 0 ho·∫∑c c·∫£nh b√°o
                // ·ªû ƒë√¢y cho ph√©p b√°n nh∆∞ng gi√° v·ªën = 0 (L·ª£i nhu·∫≠n ·∫£o cao)
            }

            // L∆ØU C·ª®NG COST PRICE V√ÄO ITEM
            items.push({
                name: rawNameOnly, // L∆∞u t√™n s·∫°ch
                fullName: inputName, // L∆∞u t√™n full ƒë·ªÉ hi·ªÉn th·ªã l·∫°i
                quantity: qty, 
                price: price,
                costPrice: currentCost // Quan tr·ªçng: L∆∞u gi√° v·ªën t·∫°i th·ªùi ƒëi·ªÉm b√°n
            }); 
            totalRev += (qty * price); 
        }
        
        if(items.length === 0) return; 
        const ship = parseFloat(document.getElementById('shippingCost').value)||0;
        const note = document.getElementById('orderNote').value;
        const internalNote = document.getElementById('internalNote').value;
        const custName = document.getElementById('custName').value.trim();
        const custPhone = document.getElementById('custPhone').value.trim();
        const custAddr = document.getElementById('custAddress').value.trim();
        if(!custPhone) { alert("Nh·∫≠p SƒêT Kh√°ch h√†ng!"); return; }
        const orderDate = document.getElementById('orderDate').value ? new Date(document.getElementById('orderDate').value).toISOString() : new Date().toISOString();
        
        const order = { 
            id: document.getElementById('invID').textContent, 
            date: orderDate, 
            customer: { name: custName, phone: custPhone, address: custAddr }, 
            staff: document.getElementById('saleStaffSelect').value, 
            items: items, 
            shipping: ship, 
            note: note, 
            internalNote: internalNote, 
            totalAmount: totalRev + ship, 
            cost: totalCost // T·ªïng gi√° v·ªën c·ªßa ƒë∆°n h√†ng
        };
        
        let orders = loadData(KEYS.ORDERS);
        if(editingOrderId) { 
            const oldIdx = orders.findIndex(o => o.id === editingOrderId);
            if (oldIdx !== -1) {
                // Ho√†n l·∫°i kho c≈©
                orders[oldIdx].items.forEach(i => { 
                    const p = stockData.find(s => normalizeStr(s.name) === normalizeStr(i.name)); 
                    if(p) p.quantityOut -= i.quantity; 
                }); 
                // Tr·ª´ kho m·ªõi
                items.forEach(i => { 
                    const p = stockData.find(s => normalizeStr(s.name) === normalizeStr(i.name)); 
                    if(p) p.quantityOut += i.quantity; 
                }); 
                orders[oldIdx] = order; alert('ƒê√£ c·∫≠p nh·∫≠t ƒë∆°n h√†ng!'); 
            }
        } else { 
            // Tr·ª´ kho cho ƒë∆°n m·ªõi
            items.forEach(i => { 
                const p = stockData.find(s => normalizeStr(s.name) === normalizeStr(i.name)); 
                if(p) p.quantityOut += i.quantity; 
            }); 
            orders.push(order); alert('ƒê√£ l∆∞u ƒë∆°n m·ªõi!'); 
        }

        let customers = loadData(KEYS.CUSTOMERS);
        let existingCustIndex = customers.findIndex(c => String(c.phone).trim() === String(custPhone).trim());
        if (existingCustIndex >= 0) { customers[existingCustIndex].name = custName; customers[existingCustIndex].address = custAddr; } 
        else { customers.push({name: custName, phone: custPhone, address: custAddr}); }
        saveData(KEYS.CUSTOMERS, customers);
        saveData(KEYS.STOCK, stockData); saveData(KEYS.ORDERS, orders); cancelEditOrder();
    };

    const updateProductDatalist = (el) => { const stock = loadData(KEYS.STOCK); document.getElementById(el).innerHTML = stock.map(s => `<option value="${s.name} {V:${s.costPrice}}">T·ªìn: ${s.quantityIn - s.quantityOut} - V·ªën: ${formatCurrency(s.costPrice)}</option>`).join(''); }
    const updateInvoicePreview = () => { 
        const id = editingOrderId || (document.getElementById('orderIDDisplay')?.value || generateID()); document.getElementById('invID').textContent = id; 
        const inputDate = document.getElementById('orderDate').value; document.getElementById('invDate').textContent = inputDate ? new Date(inputDate).toLocaleDateString('vi-VN') : new Date().toLocaleDateString('vi-VN'); 
        document.getElementById('invStaff').textContent = document.getElementById('saleStaffSelect').value || '...'; 
        const s = loadData(KEYS.STAFF).find(x => x.name === document.getElementById('saleStaffSelect').value); document.getElementById('invStaffPhone').textContent = s ? s.phone : '...'; 
        document.getElementById('invCustName').textContent = document.getElementById('custName').value || '...'; 
        document.getElementById('invCustPhone').textContent = document.getElementById('custPhone').value || '...'; 
        document.getElementById('invCustAddr').textContent = document.getElementById('custAddress').value || '...'; 
        document.getElementById('invNoteText').textContent = document.getElementById('orderNote').value || '...'; 
        
        let subTotal = 0, htmlRows = '', stt = 1; 
        document.querySelectorAll('#orderItemsBody tr').forEach(row => { 
            const rawName = row.querySelector('.item-name').value; const displayName = rawName.split(' {V:')[0]; const qty = parseFloat(row.querySelector('.item-qty').value)||0; const price = parseFloat(row.querySelector('.item-price').value)||0; const total = qty * price; 
            if(rawName) { subTotal += total; htmlRows += `<tr><td class="text-center">${stt++}</td><td>${displayName}</td><td class="text-center">C√°i</td><td class="text-center">${qty}</td><td class="text-right">${formatCurrency(price).replace('‚Ç´','')}</td><td class="text-right">${formatCurrency(total).replace('‚Ç´','')}</td></tr>`; } 
        }); 
        document.getElementById('invItemsList').innerHTML = htmlRows; document.getElementById('invSubTotal').textContent = formatCurrency(subTotal); 
        const ship = parseFloat(document.getElementById('shippingCost').value)||0; document.getElementById('invShip').textContent = formatCurrency(ship); 
        document.getElementById('invTotal').textContent = formatCurrency(subTotal+ship); document.getElementById('invTotalText').textContent = "(B·∫±ng ch·ªØ)"; 
    };

    const createOrderItemRow = (p='', q=1, pr=0) => {const tbody = document.getElementById('orderItemsBody'); const row = tbody.insertRow(); row.innerHTML = `<td><input type="text" class="form-control item-name" list="productListSales" value="${p}" placeholder="G√µ t√™n..." onchange="updateInvoicePreview()"></td><td><input type="number" class="form-control item-qty" value="${q}" oninput="updateInvoicePreview()"></td><td><input type="number" class="form-control item-price" value="${pr||''}" placeholder="0" oninput="updateInvoicePreview()"></td><td><button class="btn btn-danger btn-sm" onclick="this.closest('tr').remove(); updateInvoicePreview()">x</button></td>`;};
    
    const startEditOrder = (id) => { 
        const o = loadData(KEYS.ORDERS).find(x=>x.id===id); if(!o) return; 
        switchTab('tab-sales'); editingOrderId = id; 
        document.getElementById('editModeBanner').style.display='block'; document.getElementById('editingOrderIDText').textContent = id; 
        document.getElementById('btnSaveOrder').textContent = "üíæ C·∫¨P NH·∫¨T"; document.getElementById('btnSaveOrder').classList.replace('btn-primary','btn-warning'); document.getElementById('btnCancelEdit').style.display = 'inline-block'; 
        document.getElementById('custPhone').value = o.customer.phone; document.getElementById('custName').value = o.customer.name; document.getElementById('custAddress').value = o.customer.address; 
        document.getElementById('shippingCost').value = o.shipping; document.getElementById('orderNote').value = o.note || ''; document.getElementById('internalNote').value = o.internalNote || ''; 
        document.getElementById('saleStaffSelect').value = o.staff; document.getElementById('orderItemsBody').innerHTML=''; 
        o.items.forEach(i=>createOrderItemRow(i.fullName || i.name, i.quantity, i.price)); // D√πng fullName ƒë·ªÉ load l·∫°i datalist
        if(o.date) document.getElementById('orderDate').value = new Date(o.date).toISOString().slice(0,10); 
        updateInvoicePreview(); 
    }
    
    const cancelEditOrder = () => { 
        editingOrderId = null; document.getElementById('editModeBanner').style.display='none'; 
        document.getElementById('btnSaveOrder').textContent = "‚úÖ L∆ØU ƒê∆†N"; document.getElementById('btnSaveOrder').classList.replace('btn-warning','btn-primary'); document.getElementById('btnCancelEdit').style.display='none'; 
        document.getElementById('custPhone').value=''; document.getElementById('custName').value=''; document.getElementById('custAddress').value=''; document.getElementById('shippingCost').value=0; document.getElementById('orderNote').value=''; document.getElementById('internalNote').value=''; 
        document.getElementById('orderItemsBody').innerHTML=''; createOrderItemRow(); document.getElementById('orderDate').value = new Date().toISOString().slice(0,10); updateInvoicePreview(); 
    }

    // --- KHO H√ÄNG & NH√ÇN S·ª∞ ---
    const renderStaff = () => { document.querySelector('#staffTable tbody').innerHTML = loadData(KEYS.STAFF).map((s, i) => `<tr><td>${s.name}</td><td>${s.phone}</td><td>${s.address}</td><td>${s.note}</td><td><button class="btn btn-danger btn-sm" onclick="deleteItem('${KEYS.STAFF}', ${i}, renderStaff)">X</button></td></tr>`).join(''); };
    const handleAddStaff = (e) => { e.preventDefault(); const staff = loadData(KEYS.STAFF); staff.push({ name: document.getElementById('staffName').value, phone: document.getElementById('staffPhone').value, address: document.getElementById('staffAddress').value, note: document.getElementById('staffNote').value }); saveData(KEYS.STAFF, staff); renderStaff(); e.target.reset(); };
    const populateStaffSelect = () => { document.getElementById('saleStaffSelect').innerHTML = '<option value="">-- Ch·ªçn sales --</option>' + loadData(KEYS.STAFF).map(s => `<option value="${s.name}">${s.name}</option>`).join(''); };

    const renderSuppliers = () => { document.querySelector('#supplierTable tbody').innerHTML = loadData(KEYS.SUPPLIERS).map((s, i) => `<tr><td>${s.name}</td><td>${s.phone}</td><td>${s.address}</td><td><button class="btn btn-danger btn-sm" onclick="deleteItem('${KEYS.SUPPLIERS}', ${i}, renderSuppliers)">X</button></td></tr>`).join(''); };
    const handleAddSupplier = (e) => { e.preventDefault(); const sups = loadData(KEYS.SUPPLIERS); sups.push({ name: document.getElementById('suppName').value, phone: document.getElementById('suppPhone').value, address: document.getElementById('suppAddr').value }); saveData(KEYS.SUPPLIERS, sups); renderSuppliers(); populateSupplierSelect(); e.target.reset(); };
    const populateSupplierSelect = () => { const sups = loadData(KEYS.SUPPLIERS); [document.getElementById('stockSupplier'), document.getElementById('filterSupplier')].forEach(el => { if(el) el.innerHTML = '<option value="">-- Ch·ªçn NCC --</option>' + sups.map(s => `<option value="${s.name}">${s.name}</option>`).join(''); }); };
    
    const createStockRow = () => { const tbody = document.getElementById('stockEntryBody'); const row = tbody.insertRow(); row.innerHTML = `<td><input type="text" class="form-control stock-name" list="productListStock" placeholder="T√™n SP"></td><td><input type="number" class="form-control stock-qty" value="1"></td><td><input type="number" class="form-control stock-price" placeholder="Gi√° v·ªën"></td><td><input type="text" class="form-control stock-note"></td><td><button class="btn btn-danger btn-sm" onclick="this.closest('tr').remove()">x</button></td>`; };
    
    const submitStockEntry = () => {
        const supplier = document.getElementById('stockSupplier').value; const rows = document.querySelectorAll('#stockEntryBody tr'); let stock = loadData(KEYS.STOCK);
        rows.forEach(row => {
            const name = row.querySelector('.stock-name').value.split(' {V:')[0]; const qty = parseFloat(row.querySelector('.stock-qty').value); const price = parseFloat(row.querySelector('.stock-price').value); const note = row.querySelector('.stock-note').value;
            if(name && qty > 0) {
                let exist = stock.find(s => normalizeStr(s.name) === normalizeStr(name) && s.costPrice == price);
                if(exist) { exist.quantityIn += qty; exist.supplier = supplier || exist.supplier; }
                else { stock.push({ name, quantityIn: qty, quantityOut: 0, costPrice: price || 0, supplier, note }); }
            }
        });
        saveData(KEYS.STOCK, stock); alert('Nh·∫≠p kho th√†nh c√¥ng!'); renderInventory(); document.getElementById('stockEntryBody').innerHTML=''; createStockRow();
    };

    const renderInventory = () => {
        let stock = loadData(KEYS.STOCK); const filterSup = document.getElementById('filterSupplier').value;
        if(filterSup) stock = stock.filter(s => s.supplier === filterSup);
        document.querySelector('#inventoryTable tbody').innerHTML = stock.map((s, i) => `
            <tr>
                <td><input type="text" class="editable-input" value="${s.name}" onchange="updateStockItem(${i}, 'name', this.value)"></td>
                <td class="text-center"><input type="number" style="width:60px" value="${s.quantityIn}" onchange="updateStockItem(${i}, 'quantityIn', this.value)"></td>
                <td class="text-center">${s.quantityOut}</td>
                <td class="text-center" style="font-weight:bold; color:${(s.quantityIn-s.quantityOut)<5?'red':'green'}">${s.quantityIn - s.quantityOut}</td>
                <td class="text-right"><input type="number" style="width:80px" value="${s.costPrice}" onchange="updateStockItem(${i}, 'costPrice', this.value)"></td>
                <td><input type="text" style="width:100%" value="${s.note||''}" onchange="updateStockItem(${i}, 'note', this.value)"></td>
                <td><button class="btn btn-danger btn-sm" onclick="deleteItem('${KEYS.STOCK}', ${i}, renderInventory)">X</button></td>
            </tr>`).join('');
    };

    const updateStockItem = (index, field, value) => {
        let stock = loadData(KEYS.STOCK);
        if(field === 'quantityIn' || field === 'costPrice') value = parseFloat(value) || 0;
        stock[index][field] = value;
        saveData(KEYS.STOCK, stock);
        renderInventory(); 
        updateProductDatalist('productListStock');
    };

    // --- B√ÅO C√ÅO & THU CHI ---
    // S·ª≠a l·ªói: G·ªçi saveData v√† renderCashflow ngay sau khi push
    const handleCashflowSubmit = (e) => { 
        e.preventDefault(); 
        const cf = { date: document.getElementById('cfDate').value, type: document.getElementById('cfType').value, amount: parseFloat(document.getElementById('cfAmount').value), orderId: document.getElementById('cfOrderId').value, category: document.getElementById('cfCategory').value, note: document.getElementById('cfNote').value }; 
        const list = loadData(KEYS.CASHFLOW);
        list.push(cf); 
        saveData(KEYS.CASHFLOW, list); // L∆∞u ngay
        renderCashflow(); // Render ngay
        e.target.reset(); 
        alert("ƒê√£ l∆∞u phi·∫øu th√†nh c√¥ng!");
    };
    
    const renderCashflow = () => { document.querySelector('#cashflowTable tbody').innerHTML = loadData(KEYS.CASHFLOW).sort((a,b)=>new Date(b.date)-new Date(a.date)).map((c, i) => `<tr><td>${c.date}</td><td style="color:${c.type==='THU'?'green':'red'}">${c.type}</td><td>${formatCurrency(c.amount)}</td><td>${c.orderId||'-'}</td><td>${c.category}</td><td><button class="btn btn-danger btn-sm" onclick="deleteItem('${KEYS.CASHFLOW}', ${i}, renderCashflow)">X</button></td></tr>`).join(''); };
    const updateOrderDatalist = () => { document.getElementById('orderListSuggestions').innerHTML = loadData(KEYS.ORDERS).map(o => `<option value="${o.id}">`).join(''); }

    const filterReports = (period) => {
        currentReportPeriod = period;
        document.querySelectorAll('.filter-bar .btn').forEach(b => b.classList.remove('btn-primary'));
        document.querySelectorAll('.filter-bar .btn').forEach(b => b.classList.add('btn-secondary'));
        document.getElementById(`btn-${period}`).classList.remove('btn-secondary');
        document.getElementById(`btn-${period}`).classList.add('btn-primary');

        let start = new Date(), end = new Date();
        start.setHours(0,0,0,0); end.setHours(23,59,59,999);

        // Logic th·ªùi gian th·ª±c
        if(period === 'week') { const day = start.getDay(); start.setDate(start.getDate() - day + (day == 0 ? -6:1)); start.setHours(0,0,0,0); }
        else if(period === 'month') { start.setDate(1); }
        else if(period === 'year') { start.setMonth(0, 1); }
        else if(period === 'all') { start = new Date(2000, 0, 1); }
        else if(period === 'custom') { start = new Date(document.getElementById('filterStart').value); end = new Date(document.getElementById('filterEnd').value); end.setHours(23,59,59,999); }
        
        const orders = loadData(KEYS.ORDERS).filter(o => { const d = new Date(o.date); return d >= start && d <= end; });
        const cashflow = loadData(KEYS.CASHFLOW).filter(c => { const d = new Date(c.date); return d >= start && d <= end; });
        const stock = loadData(KEYS.STOCK); // T·ªïng kho th√¨ t√≠nh to√†n b·ªô hi·ªán t·∫°i
        
        // T√≠nh KPI
        const rev = orders.reduce((sum, o) => sum + o.totalAmount, 0); // T·ªïng doanh thu
        
        // COGS (Gi√° v·ªën h√†ng b√°n): L·∫•y t·ª´ cost ƒë√£ l∆∞u trong ƒë∆°n h√†ng
        const cogs = orders.reduce((sum, o) => sum + (o.cost || 0), 0); 
        
        // C·∫¨P NH·∫¨T LOGIC CHI PH√ç
        // 1. Chi ph√≠ ƒë∆°n h√†ng: L√† c√°c phi·∫øu CHI c√≥ m√£ PXK
        const orderCosts = cashflow.filter(c => c.type === 'CHI' && c.orderId && c.orderId.trim() !== '').reduce((sum, c) => sum + c.amount, 0);
        
        // 2. Chi ph√≠ v·∫≠n h√†nh: L√† c√°c phi·∫øu CHI KH√îNG c√≥ m√£ PXK
        const opExp = cashflow.filter(c => c.type === 'CHI' && (!c.orderId || c.orderId.trim() === '')).reduce((sum, c) => sum + c.amount, 0);
        
        const otherInc = cashflow.filter(c => c.type === 'THU').reduce((sum, c) => sum + c.amount, 0);
        
        // T·ªïng v·ªën nh·∫≠p (Hi·ªán t·∫°i trong kho - T√†i s·∫£n)
        const totalImport = stock.reduce((sum, s) => sum + (s.quantityIn * s.costPrice), 0);
        
        // L√£i G·ªôp = Doanh Thu - Gi√° V·ªën - Chi Ph√≠ ƒê∆°n (Ship, v.v...)
        const grossProfit = rev - cogs - orderCosts;
        
        // L√£i R√≤ng = L√£i G·ªôp + Thu Kh√°c - Chi Ph√≠ V·∫≠n H√†nh
        const netProfit = grossProfit + otherInc - opExp;

        // Hi·ªÉn th·ªã KPI Cards
        document.getElementById('kpiRevenue').textContent = formatCurrency(rev);
        document.getElementById('kpiTotalImport').textContent = formatCurrency(totalImport);
        document.getElementById('kpiTotalExpense').textContent = formatCurrency(opExp);
        document.getElementById('kpiNetProfit').textContent = formatCurrency(netProfit);

        // B·∫£ng c√¢n ƒë·ªëi chi ti·∫øt
        document.getElementById('rptRev').textContent = formatCurrency(rev);
        document.getElementById('rptCOGS').textContent = formatCurrency(cogs);
        document.getElementById('rptOrderCost').textContent = formatCurrency(orderCosts);
        document.getElementById('rptGrossProfit').textContent = formatCurrency(grossProfit);
        document.getElementById('rptOpExp').textContent = formatCurrency(opExp);
        document.getElementById('rptOtherInc').textContent = formatCurrency(otherInc);
        document.getElementById('rptNetProfit').textContent = formatCurrency(netProfit);
        
        const margin = rev > 0 ? (grossProfit/rev*100).toFixed(1) : 0;
        document.getElementById('profitMargin').textContent = margin + '%';
        document.getElementById('barProfit').style.width = Math.max(0, margin) + '%';

        renderOrderReportTable(orders);
        renderExpenseDetails(orders, cashflow);
        renderCharts(orders); // V·∫Ω bi·ªÉu ƒë·ªì
    };

    // --- CHART LOGIC (M·ªöI) ---
    const renderCharts = (orders) => {
        // 1. Top Sales
        const staffSales = {};
        orders.forEach(o => {
            const name = o.staff || 'Ch∆∞a g√°n';
            staffSales[name] = (staffSales[name] || 0) + o.totalAmount;
        });
        const sortedStaff = Object.entries(staffSales).sort((a,b) => b[1] - a[1]).slice(0, 5); // Top 5
        const maxStaffVal = sortedStaff.length > 0 ? sortedStaff[0][1] : 1;
        
        document.getElementById('chartTopSales').innerHTML = `
            <div class="chart-container">
                ${sortedStaff.map(item => `
                    <div class="chart-column">
                        <div class="chart-value">${formatCurrency(item[1], true)}</div>
                        <div class="chart-bar" style="height: ${Math.max(5, (item[1]/maxStaffVal)*80)}%; background: var(--primary-color);"></div>
                        <div class="chart-label">${item[0]}</div>
                    </div>
                `).join('')}
            </div>`;

        // 2. Top Kh√°ch H√†ng
        const custSales = {};
        orders.forEach(o => {
            const name = o.customer.name || 'Kh√°ch l·∫ª';
            custSales[name] = (custSales[name] || 0) + o.totalAmount;
        });
        const sortedCust = Object.entries(custSales).sort((a,b) => b[1] - a[1]).slice(0, 5); // Top 5
        const maxCustVal = sortedCust.length > 0 ? sortedCust[0][1] : 1;

        document.getElementById('chartTopCustomers').innerHTML = `
            <div class="chart-container">
                ${sortedCust.map(item => `
                    <div class="chart-column">
                        <div class="chart-value">${formatCurrency(item[1], true)}</div>
                        <div class="chart-bar" style="height: ${Math.max(5, (item[1]/maxCustVal)*80)}%; background: var(--success-color);"></div>
                        <div class="chart-label">${item[0]}</div>
                    </div>
                `).join('')}
            </div>`;
    };

    const renderOrderReportTable = (orders) => {
        document.querySelector('#rptOrdersTable tbody').innerHTML = orders.map(o => `
            <tr>
                <td>${o.customer.name}<br><small>${o.customer.phone}</small></td>
                <td><span style="color:blue; cursor:pointer;" onclick="startEditOrder('${o.id}')">${o.id}</span></td>
                <td>${new Date(o.date).toLocaleDateString('vi-VN')}</td>
                <td style="color:#dc3545;font-style:italic">${o.internalNote || ''}</td>
                <td class="text-right">${formatCurrency(o.totalAmount)}</td>
                <td class="text-right" style="font-weight:bold; color:green;">${formatCurrency(o.totalAmount - (o.cost||0))}</td>
                <td>
                    <button class="btn btn-primary btn-sm" onclick="startEditOrder('${o.id}')">‚úèÔ∏è S·ª≠a</button>
                    <button class="btn btn-danger btn-sm" onclick="deleteOrder('${o.id}')">X</button>
                </td>
            </tr>`).join('');
    };

    const renderExpenseDetails = (orders, cashflow) => {
        // 1. Chi ph√≠ ƒë∆°n h√†ng: Cashflow CHI + C√≥ OrderID
        const orderExps = cashflow.filter(c => c.type === 'CHI' && c.orderId && c.orderId.trim() !== '');
        document.querySelector('#rptOrderExpTable tbody').innerHTML = orderExps.map(c => `<tr><td>${c.date}</td><td>${c.orderId}</td><td>${formatCurrency(c.amount)}</td><td>${c.category} - ${c.note}</td></tr>`).join('');
        
        // 2. Chi ph√≠ v·∫≠n h√†nh: Cashflow CHI + KH√îNG OrderID
        const opExps = cashflow.filter(c => c.type === 'CHI' && (!c.orderId || c.orderId.trim() === ''));
        document.querySelector('#rptGenExpTable tbody').innerHTML = opExps.map(c => `<tr><td>${c.date}</td><td>${c.category}</td><td>${formatCurrency(c.amount)}</td></tr>`).join('');
    };

    const searchOrderTable = () => { const term = document.getElementById('searchOrderReport').value.toLowerCase(); const orders = loadData(KEYS.ORDERS).filter(o => o.id.toLowerCase().includes(term)); renderOrderReportTable(orders); };
    const toggleCustomFilter = () => { document.getElementById('customFilterArea').classList.toggle('active'); };
    
    // Generic & Delete
    const deleteItem = (key, index, callback) => { if(!confirm('Ch·∫Øc ch·∫Øn x√≥a?')) return; const data = loadData(key); data.splice(index, 1); saveData(key, data); callback(); };
    
    const deleteOrder = (id) => {
         if(!confirm('X√≥a ƒë∆°n h√†ng s·∫Ω ho√†n l·∫°i s·ªë l∆∞·ª£ng t·ªìn kho. Ti·∫øp t·ª•c?')) return;
         let orders = loadData(KEYS.ORDERS);
         let stock = loadData(KEYS.STOCK);
         const o = orders.find(x => x.id === id);
         if(o) {
             o.items.forEach(i => {
                 // T√¨m l·∫°i sp trong kho ƒë·ªÉ c·ªông t·ªìn (kh√¥ng ph√¢n bi·ªát hoa th∆∞·ªùng)
                 const p = stock.find(s => normalizeStr(s.name) === normalizeStr(i.name));
                 if(p) p.quantityOut -= i.quantity;
             });
         }
         orders = orders.filter(x => x.id !== id);
         saveData(KEYS.STOCK, stock);
         saveData(KEYS.ORDERS, orders);
         alert('ƒê√£ x√≥a ƒë∆°n h√†ng!');
         filterReports(currentReportPeriod);
    };

    const printInvoice = () => { const content = document.getElementById('invoicePreview').innerHTML; const win = window.open('','','width=800,height=600'); win.document.write('<html><head><title>In H√≥a ƒê∆°n</title><style>body{font-family:"Times New Roman"; padding:20px;} .invoice-box{width:100%;} .inv-table{width:100%;border-collapse:collapse;} .inv-table th, .inv-table td{border:1px solid #000;padding:5px;} .inv-title{text-align:center;font-size:24px;font-weight:bold;} .text-right{text-align:right;} .text-center{text-align:center;}</style></head><body>'+content+'</body></html>'); win.document.close(); win.print(); };
    const exportData = () => { const data = {}; Object.values(KEYS).forEach(k => data[k] = localStorage.getItem(k)); const blob = new Blob([JSON.stringify(data)], {type: 'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `backup_${new Date().toISOString().slice(0,10)}.json`; a.click(); };
    const handleFileImport = (e) => { const file = e.target.files[0]; if(!file) return; const reader = new FileReader(); reader.onload = (e) => { try { const data = JSON.parse(e.target.result); Object.keys(data).forEach(k => localStorage.setItem(k, data[k])); alert('Ph·ª•c h·ªìi xong!'); location.reload(); } catch { alert('File l·ªói!'); } }; reader.readAsText(file); };
</script>
</body>
</html>

